<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CN ‚Äì Cenov√° nab√≠dka materi√°lu</title>
<script src="data.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Segoe UI',system-ui,sans-serif;background:#f5f4f0;color:#1a1a1a;min-height:100vh;display:flex;}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar{width:240px;min-height:100vh;background:#1a1a14;display:flex;flex-direction:column;flex-shrink:0;position:fixed;top:0;left:0;bottom:0;overflow-y:auto;z-index:100;}
.sidebar-logo{padding:24px 22px 18px;border-bottom:1px solid rgba(255,255,255,0.07);}
.sidebar-logo .cn{font-size:22px;font-weight:800;color:#c9a84c;letter-spacing:1px;font-family:Georgia,serif;}
.sidebar-logo .cn-sub{font-size:8px;color:#5a5a48;letter-spacing:2px;text-transform:uppercase;margin-top:2px;line-height:1.4;}
.nav-label{font-size:8.5px;color:#4a4a38;letter-spacing:2.5px;text-transform:uppercase;padding:0 20px;margin:14px 0 5px;}
.nav-item{display:flex;align-items:center;gap:9px;padding:8px 20px;color:#7a7a62;font-size:12.5px;cursor:pointer;border-left:2px solid transparent;transition:all .15s;}
.nav-item:hover{color:#c9a84c;background:rgba(201,168,76,.05);}
.nav-item.active{color:#c9a84c;background:rgba(201,168,76,.08);border-left-color:#c9a84c;font-weight:600;}
.nav-sep{height:1px;background:rgba(255,255,255,0.05);margin:10px 0;}

/* Vendor list in sidebar */
.sb-vendor{display:flex;align-items:center;gap:7px;padding:6px 20px 6px 28px;color:#6a6a58;font-size:11.5px;cursor:pointer;transition:all .15s;border-left:2px solid transparent;}
.sb-vendor:hover{color:#c9a84c;background:rgba(201,168,76,.04);}
.sb-vendor .sv-dot{width:5px;height:5px;border-radius:50%;background:#3a3a2a;flex-shrink:0;}
.sb-vendor .sv-cnt{margin-left:auto;font-size:10px;color:#3a3a2a;}
.sb-vendor:hover .sv-cnt{color:#8a8a62;}

/* EUR settings in sidebar */
.eur-section{padding:8px 16px 12px;}
.eur-vendor-row{display:flex;align-items:center;gap:6px;margin-bottom:6px;font-size:11px;color:#7a7a62;}
.eur-vendor-row label{flex:1;line-height:1.3;}
.eur-vendor-row input[type="number"]{width:64px;padding:3px 5px;background:#0f0f0a;border:1px solid #3a3a2a;border-radius:4px;color:#c9a84c;font-size:11px;text-align:center;font-family:monospace;}
.eur-vendor-row input[type="number"]:focus{outline:none;border-color:#c9a84c;}
.eur-label{font-size:9px;color:#4a4a38;white-space:nowrap;}

/* ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ */
.content{margin-left:240px;flex:1;display:flex;flex-direction:column;min-height:100vh;}
.topbar{background:white;border-bottom:1px solid #e8e6e0;padding:0 24px;height:56px;display:flex;align-items:center;gap:8px;position:sticky;top:0;z-index:50;}
.topbar h1{font-size:15px;font-weight:700;color:#1a1a14;}
.proj-input{border:none;background:transparent;font-size:12px;color:#888;padding:4px 8px;border-radius:5px;min-width:180px;font-family:inherit;}
.proj-input:focus{outline:none;background:#f5f4f0;color:#333;}
.topbar .spacer{flex:1;}
.btn{padding:6px 13px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;border:none;display:inline-flex;align-items:center;gap:5px;transition:all .15s;}
.btn-ghost{background:transparent;color:#666;border:1.5px solid #ddd;}
.btn-ghost:hover{border-color:#c9a84c;color:#c9a84c;}
.btn-gold{background:#c9a84c;color:#1a1a14;}
.btn-gold:hover{background:#b8973e;}
.btn-sm{padding:4px 10px;font-size:11.5px;}

main{padding:20px 24px;flex:1;}

/* ‚îÄ‚îÄ SUMMARY STRIP ‚îÄ‚îÄ */
.summary-strip{display:flex;align-items:center;gap:16px;margin-bottom:14px;flex-wrap:wrap;}
.stat-pill{display:flex;align-items:center;gap:5px;font-size:12px;color:#666;}
.stat-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.dot-g{background:#5aab6e;}.dot-gold{background:#c9a84c;}.dot-r{background:#d44;}
.summary-strip .spacer{flex:1;}
.strip-total{font-size:15px;font-weight:800;color:#c9a84c;}
.strip-label{font-size:11px;color:#aaa;}

/* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
.card{background:white;border-radius:12px;border:1px solid #e8e6e0;overflow:hidden;margin-bottom:14px;}
.card-header{padding:12px 20px;display:flex;align-items:center;gap:9px;border-bottom:1px solid #f0ede6;}
.card-header h2{font-size:13.5px;font-weight:700;}
.badge{background:#f5f4f0;color:#888;border-radius:20px;font-size:10px;padding:2px 8px;font-weight:600;}

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;}
thead tr{background:#1a1a14;}
thead th{padding:9px 10px;text-align:left;font-size:9.5px;font-weight:700;color:#c9a84c;text-transform:uppercase;letter-spacing:.7px;white-space:nowrap;}
thead th:first-child{padding-left:18px;}
thead th:last-child{padding-right:14px;}
tbody tr{border-bottom:1px solid #f5f3ee;transition:background .1s;}
tbody tr:hover{background:#fdfcf9;}
tbody tr:last-child{border-bottom:none;}
td{padding:7px 10px;vertical-align:middle;font-size:12px;}
td:first-child{padding-left:18px;}
td:last-child{padding-right:8px;}

/* ‚îÄ‚îÄ SECTION ROW ‚îÄ‚îÄ */
tr.sec-hdr{background:#f0ede6 !important;border-bottom:2px solid #ddd;}
tr.sec-hdr:hover{background:#ede9df !important;}
.sec-inner{display:flex;align-items:center;gap:8px;}
.sec-name{border:none;background:transparent;font-size:13px;font-weight:700;color:#1a1a14;width:180px;padding:2px 4px;border-radius:4px;font-family:inherit;}
.sec-name:focus{outline:none;background:white;border:1px solid #c9a84c;}
.sec-sub{margin-left:auto;font-size:11px;color:#888;}
.sec-sub strong{color:#c9a84c;}
.btn-sec-add{background:transparent;border:1px dashed #c5c0b5;color:#aaa;padding:3px 9px;border-radius:5px;font-size:11px;cursor:pointer;transition:all .15s;}
.btn-sec-add:hover{border-color:#c9a84c;color:#c9a84c;}
.btn-sec-del{background:transparent;border:none;color:#ccc;cursor:pointer;font-size:13px;padding:2px 5px;border-radius:4px;transition:all .15s;}
.btn-sec-del:hover{background:#fff0f0;color:#d44;}

/* ‚îÄ‚îÄ INPUTS ‚îÄ‚îÄ */
select,input[type="number"],input[type="text"],textarea{width:100%;border:1.5px solid #e4e0d8;border-radius:6px;padding:5px 7px;font-size:11.5px;color:#1a1a14;background:white;outline:none;transition:border-color .15s;font-family:inherit;}
select:focus,input:focus,textarea:focus{border-color:#c9a84c;}
select{appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2.5'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 6px center;padding-right:20px;cursor:pointer;}
select:disabled{opacity:.3;cursor:default;}
.auto-fill{background:#faf9f6;border-color:#eae7df;color:#555;font-family:'Courier New',monospace;font-size:10.5px;}
input[type="number"]{text-align:center;}
textarea{resize:none;height:28px;line-height:1.4;font-size:11px;color:#888;padding-top:5px;}
.row-num{width:18px;height:18px;border-radius:4px;background:#f0ede6;color:#999;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;}
.row-num.m{background:#f5f0e0;color:#b08a30;}
.manual-tag{font-size:8px;font-weight:700;background:#f5f0e0;color:#b08a30;border-radius:3px;padding:1px 4px;letter-spacing:.5px;text-transform:uppercase;vertical-align:middle;margin-left:3px;}
.line-total{font-weight:700;font-size:12.5px;text-align:right;display:block;white-space:nowrap;}
.eur-price{color:#888;font-size:10.5px;}
.btn-del{width:22px;height:22px;border:none;background:transparent;border-radius:4px;cursor:pointer;color:#ccc;display:flex;align-items:center;justify-content:center;font-size:12px;transition:all .15s;}
.btn-del:hover{background:#fff0f0;color:#d44;}

/* ‚îÄ‚îÄ SEARCH DROPDOWN ‚îÄ‚îÄ */
.search-wrap{position:relative;}
.search-input{width:100%;border:1.5px solid #e4e0d8;border-radius:6px;padding:5px 7px;font-size:11.5px;font-family:inherit;outline:none;transition:border-color .15s;}
.search-input:focus{border-color:#c9a84c;}
.search-drop{position:fixed;background:white;border:1.5px solid #c9a84c;border-radius:8px;max-height:320px;min-width:480px;overflow-y:auto;z-index:500;box-shadow:0 8px 32px rgba(0,0,0,.18);display:none;}
.si{padding:8px 12px;font-size:12px;cursor:pointer;border-bottom:1px solid #f5f3ee;line-height:1.5;}
.si:hover{background:#faf8f2;}
.si:last-child{border-bottom:none;}
.si-code{font-family:'Courier New',monospace;color:#888;font-size:11px;}
.si-desc{color:#1a1a14;font-weight:600;font-size:12px;}
.si-price{float:right;color:#c9a84c;font-weight:700;font-size:12px;margin-left:12px;}
.si-color{color:#999;font-size:10px;}
.si-none{padding:10px;font-size:11.5px;color:#999;text-align:center;}

/* ‚îÄ‚îÄ ADD ROW FOOTER ‚îÄ‚îÄ */
.add-row-bar{padding:10px 20px;border-top:1px solid #f0ede6;display:flex;gap:8px;background:#fdfcfa;}
.btn-add-row{background:transparent;border:1.5px dashed #d0ccc2;color:#aaa;padding:4px 12px;border-radius:6px;font-size:11.5px;cursor:pointer;display:flex;align-items:center;gap:5px;transition:all .15s;}
.btn-add-row:hover{border-color:#c9a84c;color:#c9a84c;background:rgba(201,168,76,.04);}

/* ‚îÄ‚îÄ FOOTER TOTALS ‚îÄ‚îÄ */
.card-footer{padding:14px 20px;border-top:2px solid #f0ede6;display:flex;align-items:center;gap:14px;flex-wrap:wrap;}
.dph-row{display:flex;align-items:center;gap:7px;font-size:12.5px;color:#888;}
.dph-row input[type="number"]{width:55px;text-align:center;}
.totals{margin-left:auto;display:flex;align-items:center;gap:24px;}
.total-block{text-align:right;}
.total-block .lbl{font-size:10px;color:#aaa;text-transform:uppercase;letter-spacing:.5px;margin-bottom:1px;}
.total-block .val{font-size:15px;font-weight:800;color:#1a1a14;}
.total-block .val.gold{color:#c9a84c;font-size:18px;}
.divider-v{width:1px;height:28px;background:#e8e6e0;}

/* ‚îÄ‚îÄ SOURCE CELL ‚îÄ‚îÄ */
.src-cell{font-size:10px;color:#aaa;font-family:'Courier New',monospace;line-height:1.3;min-width:160px;max-width:200px;}
.src-manual{color:#c9a84c;font-style:italic;font-family:inherit;}

/* ‚îÄ‚îÄ MODAL (PRICELIST VIEWER) ‚îÄ‚îÄ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:900;display:none;align-items:flex-start;justify-content:center;padding:20px 16px;}
.modal-overlay.open{display:flex;}
.modal{background:white;border-radius:14px;width:min(1300px,96vw);max-height:92vh;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.3);}
.modal-head{background:#1a1a14;padding:18px 24px;display:flex;align-items:center;gap:12px;}
.modal-head h2{color:#c9a84c;font-size:15px;font-weight:700;font-family:Georgia,serif;}
.modal-head .cnt{color:#5a5a48;font-size:11px;}
.modal-head .spacer{flex:1;}
.modal-close{background:transparent;border:none;color:#5a5a48;font-size:20px;cursor:pointer;padding:2px 8px;border-radius:5px;transition:all .15s;}
.modal-close:hover{color:#c9a84c;}
.modal-search{padding:12px 20px;border-bottom:1px solid #f0ede6;}
.modal-search input{width:100%;padding:8px 12px;border:1.5px solid #e4e0d8;border-radius:8px;font-size:13px;font-family:inherit;outline:none;}
.modal-search input:focus{border-color:#c9a84c;}
.modal-body{overflow-y:auto;flex:1;}
.modal-body table{width:100%;border-collapse:collapse;}
.modal-body thead tr{background:#1a1a14;position:sticky;top:0;}
.modal-body thead th{padding:8px 12px;font-size:9.5px;font-weight:700;color:#c9a84c;text-transform:uppercase;letter-spacing:.6px;text-align:left;}
.modal-body tbody tr{border-bottom:1px solid #f5f3ee;}
.modal-body tbody tr:hover{background:#fdfcf9;}
.modal-body td{padding:7px 12px;font-size:11.5px;}
.modal-body .td-code{font-family:'Courier New',monospace;font-size:10.5px;color:#666;width:110px;}
.modal-body .td-price{font-weight:700;color:#c9a84c;text-align:right;white-space:nowrap;}
.modal-footer{padding:10px 20px;border-top:1px solid #f0ede6;text-align:center;font-size:11px;color:#aaa;}

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
#loading{position:fixed;inset:0;background:#1a1a14;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;}
#loading .logo{font-size:28px;font-weight:800;color:#c9a84c;letter-spacing:2px;font-family:Georgia,serif;margin-bottom:6px;}
#loading .sub{font-size:8px;color:#4a4a38;letter-spacing:3px;text-transform:uppercase;margin-bottom:20px;}
#loading .msg{color:#6a6a58;font-size:12px;}
.prog{width:180px;height:2px;background:#2a2a1e;border-radius:2px;margin-top:14px;}
.prog-fill{height:100%;background:#c9a84c;border-radius:2px;animation:prog 1.2s ease-in-out;}
@keyframes prog{from{width:0}to{width:100%}}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast{position:fixed;bottom:20px;right:20px;background:#1a1a14;color:#c9a84c;border:1px solid #c9a84c;padding:9px 16px;border-radius:8px;font-size:12.5px;font-weight:600;z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none;}
.toast.show{opacity:1;}

/* ‚îÄ‚îÄ COL WIDTHS ‚îÄ‚îÄ */
.col-n{width:32px;}.col-naz{min-width:120px;}.col-vr{min-width:110px;}.col-sr{min-width:110px;}
.col-pr{min-width:180px;}.col-bar{width:90px;}.col-kod{width:100px;}
.col-eur{width:80px;}.col-czk{width:85px;}.col-ks{width:58px;}.col-cel{width:95px;}
.col-kom{min-width:120px;}.col-src{width:160px;}.col-del{width:30px;}

/* ‚îÄ‚îÄ PRINT ‚îÄ‚îÄ */
@media print{
  .sidebar,.topbar,.btn-del,.btn-add-row,.add-row-bar,.search-drop,.toast,#loading,.modal-overlay,
  .btn-sec-add,.btn-sec-del,.summary-strip{display:none!important;}
  .content{margin-left:0!important;}
  body{background:white;}
  .card{border:none;border-radius:0;margin:0;}
  thead tr{background:#1a1a14!important;-webkit-print-color-adjust:exact;print-color-adjust:exact;}
  thead th{color:#c9a84c!important;}
  tr.sec-hdr{background:#f0ede6!important;-webkit-print-color-adjust:exact;print-color-adjust:exact;}
  .card-footer{border-top:2px solid #333;}
  @page{margin:15mm;}
}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading">
  <div class="logo">CN</div>
  <div class="sub">Cenov√° nab√≠dka materi√°lu</div>
  <div class="msg">Naƒç√≠t√°m cen√≠ky‚Ä¶</div>
  <div class="prog"><div class="prog-fill"></div></div>
</div>

<!-- PRICELIST MODAL -->
<div class="modal-overlay" id="pl-modal" onclick="closePlModal(event)">
  <div class="modal">
    <div class="modal-head">
      <h2 id="pl-vendor-name">V√Ωrobce</h2>
      <span class="cnt" id="pl-cnt"></span>
      <div class="spacer"></div>
      <button class="modal-close" onclick="closePlModal()">‚úï</button>
    </div>
    <div class="modal-search">
      <input type="text" id="pl-search" placeholder="Hledat dle k√≥du, popisu, barvy‚Ä¶" oninput="filterPl()">
    </div>
    <div class="modal-body">
      <table>
        <thead><tr>
          <th class="td-code">K√≥d</th>
          <th>Popis</th>
          <th>Barva</th>
          <th>S√©rie</th>
          <th style="text-align:right">Cena</th>
          <th>Zdroj (soubor | list | ≈ô√°dek)</th>
        </tr></thead>
        <tbody id="pl-body"></tbody>
      </table>
    </div>
    <div class="modal-footer" id="pl-footer"></div>
  </div>
</div>

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="sidebar-logo">
    <div class="cn">CN</div>
    <div class="cn-sub">Cenov√° nab√≠dka<br>materi√°lu</div>
  </div>
  <div style="padding:12px 0 4px;">
    <div class="nav-label">N√°stroje</div>
    <div class="nav-item active">‚óà Kalkulace</div>
    <div class="nav-item" onclick="saveJSON()">‚¨á Ulo≈æit (.json)</div>
    <div class="nav-item" onclick="document.getElementById('load-input').click()">‚¨Ü Naƒç√≠st (.json)</div>
    <input type="file" id="load-input" accept=".json" style="display:none" onchange="loadJSON(event)">
    <div class="nav-sep"></div>
    <div class="nav-label">Cen√≠ky v√Ωrobc≈Ø</div>
    <div id="vendor-nav"></div>
    <div class="nav-sep"></div>
    <div class="nav-label">Kurzy EUR / Kƒç</div>
    <div class="eur-section" id="eur-rates-section"></div>
  </div>
</div>

<!-- CONTENT -->
<div class="content">
  <div class="topbar">
    <h1>CN &nbsp;¬∑&nbsp;</h1>
    <input type="text" class="proj-input" id="proj-name" placeholder="N√°zev zak√°zky‚Ä¶">
    <div class="spacer"></div>
    <button class="btn btn-ghost btn-sm" onclick="exportXLSX()">‚¨á XLSX</button>
    <button class="btn btn-ghost btn-sm" onclick="window.print()">üñ® PDF</button>
    <button class="btn btn-gold btn-sm" onclick="addSection()">Ôºã Sekce</button>
  </div>

  <main>
    <div class="summary-strip">
      <div class="stat-pill"><div class="stat-dot dot-g"></div><span id="cnt-cat">0</span> z cen√≠ku</div>
      <div class="stat-pill"><div class="stat-dot dot-gold"></div><span id="cnt-man">0</span> ruƒçn√≠</div>
      <div class="stat-pill"><div class="stat-dot dot-r"></div><span id="cnt-sec">0</span> sekc√≠</div>
      <div class="spacer"></div>
      <span class="strip-label">Mezisouƒçet bez DPH&nbsp;</span>
      <span class="strip-total" id="strip-total">0 Kƒç</span>
    </div>

    <div class="card">
      <div class="card-header">
        <h2>Polo≈æky kalkulace</h2>
        <span class="badge" id="item-badge">0 polo≈æek</span>
        <div style="flex:1"></div>
      </div>

      <div class="table-wrap">
        <table id="main-table">
          <thead><tr>
            <th class="col-n">#</th>
            <th class="col-naz">N√°zev pol.</th>
            <th class="col-vr">V√Ωrobce</th>
            <th class="col-sr">S√©rie</th>
            <th class="col-pr">V√Ωrobek</th>
            <th class="col-bar">Barva / Povrch</th>
            <th class="col-kod">K√≥d</th>
            <th class="col-eur">Cena (‚Ç¨)</th>
            <th class="col-czk">Cena (Kƒç)</th>
            <th class="col-ks">Ks</th>
            <th class="col-cel">Celkem Kƒç</th>
            <th class="col-kom">Koment√°≈ô</th>
            <th class="col-src">Zdroj</th>
            <th class="col-del"></th>
          </tr></thead>
          <tbody id="rows-body"></tbody>
        </table>
      </div>

      <div class="add-row-bar">
        <button class="btn-add-row" onclick="addSection()">Ôºã P≈ôidat sekci / m√≠stnost</button>
      </div>

      <div class="card-footer">
        <div class="dph-row">
          DPH&nbsp;<input type="number" id="dph-rate" value="21" min="0" max="100" onchange="recalcAll()">&nbsp;%
        </div>
        <div class="totals">
          <div class="total-block"><div class="lbl">Bez DPH</div><div class="val" id="t-nodph">0 Kƒç</div></div>
          <div class="divider-v"></div>
          <div class="total-block"><div class="lbl">DPH (<span id="dph-lbl">21</span> %)</div><div class="val" id="t-dph">0 Kƒç</div></div>
          <div class="divider-v"></div>
          <div class="total-block"><div class="lbl">Celkem s DPH</div><div class="val gold" id="t-cdph">0 Kƒç</div></div>
        </div>
      </div>
    </div>
  </main>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ITEM_TYPES = [
  '‚Äî typ polo≈æky ‚Äî',
  'Umyvadlo','WC','Bidet',
  'Baterie umyvadlov√°','Baterie sprchov√°','Baterie vanov√°','Baterie kuchy≈àsk√°',
  'Sifon','Roh√°ƒçek','Ventil','P≈ôipojovac√≠ materi√°l',
  'Vana','Sprchov√° vaniƒçka','Sprchov√Ω kout / z√°stƒõna','Sprchov√Ω ≈ælab',
  'Obklad','Dla≈æba','Sokl√≠k',
  'Zrcadlo','Osvƒõtlen√≠',
  'Koupelnov√Ω n√°bytek','P≈ôedstƒõnov√Ω syst√©m / modul',
  'Doplnƒõk / p≈ô√≠slu≈°enstv√≠','Mont√°≈æ','Ostatn√≠'
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const S = {
  sections: [],    // [{id, name}]
  rowData: {},     // rid -> {type, secId, nazev, vendor, series, product, code, priceNative, priceCurrency, priceEur, priceCzk, color, qty, note, source}
  sectionRows: {}, // secId -> [rid, ...]
  eurRates: {},    // vendor -> rate
  dph: 21,
  _sid: 0, _rid: 0,
  newSid(){ return ++this._sid; },
  newRid(){ return ++this._rid; }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    document.getElementById('loading').style.display = 'none';
    initEurRates();
    buildSidebar();
    addSection('M√≠stnost 1');
  }, 700);
});

function initEurRates() {
  if (typeof PRICE_CURRENCY !== 'undefined') {
    Object.keys(PRICE_CURRENCY).forEach(v => {
      if (PRICE_CURRENCY[v] === 'EUR') S.eurRates[v] = 25.50;
    });
  }
}

function buildSidebar() {
  // Vendor nav
  const nav = document.getElementById('vendor-nav');
  const vendors = Object.keys(PRICELIST).sort();
  vendors.forEach(v => {
    const cnt = Object.values(PRICELIST[v]).reduce((a,b)=>a+b.length,0);
    const d = document.createElement('div');
    d.className = 'sb-vendor';
    const isEur = S.eurRates[v] !== undefined;
    d.innerHTML = `<div class="sv-dot" style="${isEur?'background:#c9a84c':''}"></div>
      <span style="flex:1">${esc(v)}</span>
      <span class="sv-cnt">${cnt.toLocaleString('cs')}</span>`;
    d.title = `Zobrazit cen√≠k: ${v}`;
    d.addEventListener('click', () => openPlModal(v));
    nav.appendChild(d);
  });

  // EUR rates section
  const eur = document.getElementById('eur-rates-section');
  const eurVendors = Object.keys(S.eurRates);
  if (eurVendors.length === 0) {
    eur.innerHTML = '<div style="font-size:10.5px;color:#3a3a2a;padding:4px 0">≈Ω√°dn√© EUR cen√≠ky</div>';
    return;
  }
  eurVendors.forEach(v => {
    const row = document.createElement('div');
    row.className = 'eur-vendor-row';
    row.innerHTML = `<label>${esc(v.split('(')[0].trim())}<br><span class="eur-label">EUR ‚Üí Kƒç</span></label>
      <input type="number" id="eur-${encodeVendor(v)}" value="${S.eurRates[v]}" min="1" max="99" step="0.01"
        onchange="updateEurRate('${encodeVendor(v)}','${esc(v)}')" title="Kurz EUR/Kƒç pro ${v}">`;
    eur.appendChild(row);
  });
}

function encodeVendor(v){ return v.replace(/[^a-zA-Z0-9]/g,'_'); }

function updateEurRate(key, vendor) {
  const val = parseFloat(document.getElementById(`eur-${key}`)?.value) || 25.5;
  S.eurRates[vendor] = val;
  recalcAll();
  showToast(`Kurz ${vendor}: ${val} Kƒç/‚Ç¨`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SECTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addSection(name) {
  const sid = S.newSid();
  S.sections.push({id:sid, name: name || `M√≠stnost ${sid}`});
  S.sectionRows[sid] = [];
  renderSectionHeader(sid);
  addCatalogRow(sid);
  updateSummary();
}

function renderSectionHeader(sid) {
  const tbody = document.getElementById('rows-body');
  const sec = S.sections.find(s=>s.id===sid);
  const tr = document.createElement('tr');
  tr.className = 'sec-hdr'; tr.id = `sec-${sid}`;
  tr.innerHTML = `<td colspan="14"><div class="sec-inner">
    <input type="text" class="sec-name" value="${esc(sec.name)}" placeholder="N√°zev sekce‚Ä¶"
      onchange="S.sections.find(s=>s.id===${sid}).name=this.value;recalcAll()">
    <span class="sec-sub">Sekce celkem:&nbsp;<strong id="sec-tot-${sid}">0 Kƒç</strong></span>
    <button class="btn-sec-add" onclick="addCatalogRow(${sid})">Ôºã Z cen√≠ku</button>
    <button class="btn-sec-add" onclick="addManualRow(${sid})">‚úé Ruƒçnƒõ</button>
    <button class="btn-sec-del" onclick="deleteSection(${sid})" title="Smazat sekci">‚úï sekce</button>
  </div></td>`;
  tbody.appendChild(tr);
}

function deleteSection(sid) {
  if (!confirm('Smazat sekci a v≈°echny jej√≠ ≈ô√°dky?')) return;
  (S.sectionRows[sid]||[]).forEach(rid => { document.getElementById(`row-${rid}`)?.remove(); });
  document.getElementById(`sec-${sid}`)?.remove();
  S.sections = S.sections.filter(s=>s.id!==sid);
  delete S.sectionRows[sid];
  Object.keys(S.rowData).forEach(rid => { if (S.rowData[rid].secId===sid) delete S.rowData[rid]; });
  recalcAll(); updateSummary();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ROWS ‚Äì CATALOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addCatalogRow(sid) {
  if (!sid) { sid = S.sections[S.sections.length-1]?.id; if (!sid){addSection();return;} }
  const rid = S.newRid();
  S.sectionRows[sid].push(rid);
  S.rowData[rid] = {type:'catalog',secId:sid,nazev:'',vendor:'',series:'',product:'',code:'',priceNative:0,priceCurrency:'CZK',color:'',qty:1,note:'',source:''};

  const vendors = Object.keys(PRICELIST).sort();
  const vOpts = vendors.map(v=>`<option value="${esc(v)}">${esc(v)}</option>`).join('');
  const nOpts = ITEM_TYPES.map(t=>`<option value="${esc(t)}">${esc(t)}</option>`).join('');

  const tbody = document.getElementById('rows-body');
  const tr = document.createElement('tr');
  tr.id=`row-${rid}`; tr.dataset.rid=rid; tr.dataset.sid=sid;
  tr.innerHTML = `
    <td class="col-n"><div class="row-num" id="rn-${rid}">‚Äî</div></td>
    <td class="col-naz"><select id="naz-${rid}" onchange="S.rowData[${rid}].nazev=this.value">
      ${nOpts}</select></td>
    <td class="col-vr"><select id="sel-v-${rid}" onchange="onVendor(${rid})">
      <option value="">‚Äî v√Ωrobce ‚Äî</option>${vOpts}</select></td>
    <td class="col-sr"><select id="sel-s-${rid}" onchange="onSeries(${rid})" disabled>
      <option value="">‚Äî s√©rie ‚Äî</option></select></td>
    <td class="col-pr"><div class="search-wrap">
      <input type="text" class="search-input" id="srch-${rid}" placeholder="‚Äî v√Ωrobek ‚Äî"
        oninput="onSearch(${rid})" onfocus="onSearch(${rid})" onblur="hideDrop(${rid})" disabled autocomplete="off">
      <div class="search-drop" id="drop-${rid}"></div>
    </div></td>
    <td class="col-bar"><input type="text" id="color-${rid}" placeholder="‚Äî" onchange="S.rowData[${rid}].color=this.value"></td>
    <td class="col-kod"><input class="auto-fill" type="text" id="code-${rid}" placeholder="‚Äî" readonly></td>
    <td class="col-eur"><input class="auto-fill" type="text" id="peur-${rid}" placeholder="‚Äî" readonly></td>
    <td class="col-czk"><input class="auto-fill" type="text" id="pczk-${rid}" placeholder="‚Äî" readonly></td>
    <td class="col-ks"><input type="number" id="qty-${rid}" value="1" min="1" onchange="S.rowData[${rid}].qty=+this.value;recalcRow(${rid})"></td>
    <td class="col-cel"><span class="line-total" id="tot-${rid}">‚Äî</span></td>
    <td class="col-kom"><textarea id="note-${rid}" placeholder="Pozn√°mka‚Ä¶" onchange="S.rowData[${rid}].note=this.value"></textarea></td>
    <td class="col-src src-cell" id="src-${rid}">‚Äî</td>
    <td><button class="btn-del" onclick="deleteRow(${rid})">‚úï</button></td>`;
  tbody.appendChild(tr);
  updateRowNumbers();
}

// ‚îÄ‚îÄ Catalog row events ‚îÄ‚îÄ
function onVendor(rid) {
  const v = document.getElementById(`sel-v-${rid}`).value;
  S.rowData[rid].vendor = v;
  S.rowData[rid].series = ''; S.rowData[rid].product = ''; S.rowData[rid].code = '';
  S.rowData[rid].priceNative = 0; S.rowData[rid].priceEur = 0; S.rowData[rid].priceCzk = 0;
  const ss = document.getElementById(`sel-s-${rid}`);
  const srch = document.getElementById(`srch-${rid}`);
  ss.innerHTML = '<option value="">‚Äî s√©rie ‚Äî</option>';
  ss.disabled = !v; srch.disabled = true; srch.value = '';
  clearFill(rid);
  if (!v) return;
  const series = Object.keys(PRICELIST[v]).sort();
  series.forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s; ss.appendChild(o); });
  if (series.length===1) { ss.value=series[0]; onSeries(rid); }
}

function onSeries(rid) {
  const v = document.getElementById(`sel-v-${rid}`).value;
  const s = document.getElementById(`sel-s-${rid}`).value;
  S.rowData[rid].series = s;
  const srch = document.getElementById(`srch-${rid}`);
  srch.disabled = !s; srch.value = ''; srch.dataset.v=v; srch.dataset.s=s;
  srch.placeholder = s ? `Hledat v ${s.substring(0,25)}‚Ä¶` : '‚Äî v√Ωrobek ‚Äî';
  clearFill(rid);
}

let _st={};
function onSearch(rid) {
  const srch = document.getElementById(`srch-${rid}`);
  if (srch.disabled) return;
  clearTimeout(_st[rid]);
  _st[rid] = setTimeout(() => {
    const v=srch.dataset.v, s=srch.dataset.s, q=srch.value.toLowerCase().trim();
    if (!v||!s) return;
    const items = PRICELIST[v][s] || [];
    const filtered = q ? items.filter(it=>it[0].toLowerCase().includes(q)||it[1].toLowerCase().includes(q)||(it[2]&&it[2].toLowerCase().includes(q))) : items;
    const drop = document.getElementById(`drop-${rid}`);
    drop.innerHTML='';
    const top = filtered.slice(0,100);
    if (!top.length) { drop.innerHTML='<div class="si-none">Nic nenalezeno</div>'; }
    else top.forEach(it => {
      const d=document.createElement('div'); d.className='si';
      const cur = S.eurRates[v]!==undefined ? '‚Ç¨' : 'Kƒç';
      d.innerHTML=`<span class="si-price">${fmt(it[3])} ${cur}</span><div class="si-code">${esc(it[0])}${it[2]?` ¬∑ <span class="si-color">${esc(it[2])}</span>`:''}</div><div class="si-desc">${esc(it[1])}</div>`;
      d.addEventListener('mousedown',e=>{e.preventDefault();selectProduct(rid,v,it);});
      drop.appendChild(d);
    });
    positionDrop(rid);
    drop.style.display='block';
  }, 180);
}

function positionDrop(rid) {
  const srch = document.getElementById(`srch-${rid}`);
  const drop = document.getElementById(`drop-${rid}`);
  if (!srch || !drop) return;
  const r = srch.getBoundingClientRect();
  const spaceBelow = window.innerHeight - r.bottom - 8;
  const spaceAbove = r.top - 8;
  const dropH = Math.min(320, Math.max(spaceBelow, spaceAbove));
  drop.style.maxHeight = dropH + 'px';
  drop.style.left = r.left + 'px';
  drop.style.width = Math.max(480, r.width) + 'px';
  if (spaceBelow >= 200 || spaceBelow >= spaceAbove) {
    drop.style.top = (r.bottom + 3) + 'px';
    drop.style.bottom = 'auto';
  } else {
    drop.style.bottom = (window.innerHeight - r.top + 3) + 'px';
    drop.style.top = 'auto';
  }
}
function hideDrop(rid){ setTimeout(()=>{const d=document.getElementById(`drop-${rid}`);if(d)d.style.display='none';},220); }

function selectProduct(rid, vendor, it) {
  // it = [code, desc, color, price, source]
  const isEur = S.eurRates[vendor] !== undefined;
  const rate = S.eurRates[vendor] || 1;
  const priceNative = parseFloat(it[3])||0;
  const priceEur = isEur ? priceNative : null;
  const priceCzk = isEur ? priceNative * rate : priceNative;

  Object.assign(S.rowData[rid], {
    product: it[1], code: it[0], color: it[2]||'',
    priceNative, priceCurrency: isEur?'EUR':'CZK',
    priceEur, priceCzk, source: it[4]
  });

  document.getElementById(`srch-${rid}`).value = it[1];
  document.getElementById(`code-${rid}`).value = it[0];
  document.getElementById(`color-${rid}`).value = it[2]||'';
  document.getElementById(`peur-${rid}`).value = isEur ? fmt(priceNative)+' ‚Ç¨' : '‚Äî';
  document.getElementById(`pczk-${rid}`).value = fmt(priceCzk)+' Kƒç';
  document.getElementById(`src-${rid}`).textContent = it[4];

  hideDrop(rid);
  recalcRow(rid);
}

function clearFill(rid) {
  ['code','peur','pczk'].forEach(f=>{const e=document.getElementById(`${f}-${rid}`);if(e)e.value='';});
  const src=document.getElementById(`src-${rid}`); if(src)src.textContent='‚Äî';
  const tot=document.getElementById(`tot-${rid}`); if(tot)tot.textContent='‚Äî';
  Object.assign(S.rowData[rid],{priceNative:0,priceEur:null,priceCzk:0});
  recalcAll();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ROWS ‚Äì MANUAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addManualRow(sid) {
  if (!sid) { sid = S.sections[S.sections.length-1]?.id; if (!sid){addSection();return;} }
  const rid = S.newRid();
  S.sectionRows[sid].push(rid);
  S.rowData[rid] = {type:'manual',secId:sid,nazev:'',vendor:'',series:'',product:'',code:'',priceNative:0,priceCurrency:'CZK',priceEur:null,priceCzk:0,color:'',qty:1,note:'',source:'Ruƒçn√≠ z√°pis'};

  const nOpts = ITEM_TYPES.map(t=>`<option value="${esc(t)}">${esc(t)}</option>`).join('');

  const tbody = document.getElementById('rows-body');
  const tr = document.createElement('tr');
  tr.id=`row-${rid}`; tr.dataset.rid=rid; tr.dataset.sid=sid; tr.style.background='#fdfcf5';
  tr.innerHTML = `
    <td class="col-n"><div class="row-num m" id="rn-${rid}">‚Äî</div></td>
    <td class="col-naz"><select id="naz-${rid}" onchange="S.rowData[${rid}].nazev=this.value">${nOpts}</select></td>
    <td class="col-vr"><input type="text" id="mvr-${rid}" placeholder="V√Ωrobce‚Ä¶" style="font-style:italic"
      onchange="S.rowData[${rid}].vendor=this.value"></td>
    <td class="col-sr"><input type="text" id="msr-${rid}" placeholder="Kategorie‚Ä¶" style="font-style:italic"
      onchange="S.rowData[${rid}].series=this.value"></td>
    <td class="col-pr"><input type="text" id="mpr-${rid}" placeholder="N√°zev v√Ωrobku‚Ä¶" style="font-style:italic"
      onchange="S.rowData[${rid}].product=this.value">
      <span class="manual-tag">Ruƒçn√≠</span></td>
    <td class="col-bar"><input type="text" id="color-${rid}" placeholder="‚Äî" onchange="S.rowData[${rid}].color=this.value"></td>
    <td class="col-kod"><input type="text" id="code-${rid}" placeholder="K√≥d" onchange="S.rowData[${rid}].code=this.value"></td>
    <td class="col-eur">
      <input type="number" id="peur-m-${rid}" placeholder="0" min="0" step="0.01" style="font-size:11px"
        onchange="onManualPrice(${rid})" title="Cena v EUR (voliteln√©)">
    </td>
    <td class="col-czk">
      <input type="number" id="pczk-m-${rid}" placeholder="0" min="0" step="0.01" style="font-size:11px"
        onchange="onManualPriceCzk(${rid})">
    </td>
    <td class="col-ks"><input type="number" id="qty-${rid}" value="1" min="1" onchange="S.rowData[${rid}].qty=+this.value;recalcRow(${rid})"></td>
    <td class="col-cel"><span class="line-total" id="tot-${rid}">‚Äî</span></td>
    <td class="col-kom"><textarea id="note-${rid}" placeholder="Pozn√°mka‚Ä¶" onchange="S.rowData[${rid}].note=this.value"></textarea></td>
    <td class="col-src src-manual" id="src-${rid}">Ruƒçn√≠ z√°pis</td>
    <td><button class="btn-del" onclick="deleteRow(${rid})">‚úï</button></td>`;
  tbody.appendChild(tr);
  updateRowNumbers();
}

function onManualPrice(rid) {
  const eurVal = parseFloat(document.getElementById(`peur-m-${rid}`)?.value)||0;
  S.rowData[rid].priceEur = eurVal||null;
  S.rowData[rid].priceCurrency = eurVal ? 'EUR' : 'CZK';
  // Auto-fill CZK if a rate exists (use first EUR vendor rate as default, or 25.5)
  if (eurVal) {
    const rate = Object.values(S.eurRates)[0] || 25.5;
    const czk = eurVal * rate;
    S.rowData[rid].priceCzk = czk;
    S.rowData[rid].priceNative = eurVal;
    document.getElementById(`pczk-m-${rid}`).value = czk.toFixed(0);
  }
  recalcRow(rid);
}

function onManualPriceCzk(rid) {
  const czk = parseFloat(document.getElementById(`pczk-m-${rid}`)?.value)||0;
  S.rowData[rid].priceCzk = czk;
  S.rowData[rid].priceNative = czk;
  S.rowData[rid].priceCurrency = 'CZK';
  recalcRow(rid);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DELETE ROW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function deleteRow(rid) {
  const sid = S.rowData[rid]?.secId;
  document.getElementById(`row-${rid}`)?.remove();
  delete S.rowData[rid];
  if (sid && S.sectionRows[sid]) S.sectionRows[sid] = S.sectionRows[sid].filter(r=>r!==rid);
  updateRowNumbers(); recalcAll(); updateSummary();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RECALC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function recalcRow(rid) {
  const rd = S.rowData[rid]; if (!rd) return;
  const qty = parseInt(document.getElementById(`qty-${rid}`)?.value)||1;
  rd.qty = qty;
  const czk = rd.priceCzk || 0;
  const total = czk * qty;
  const el = document.getElementById(`tot-${rid}`);
  if (el) el.textContent = czk > 0 ? fmt(total)+' Kƒç' : '‚Äî';
  recalcAll();
}

function recalcAll() {
  let grand = 0;
  // Per-section totals
  S.sections.forEach(sec => {
    let secTot = 0;
    (S.sectionRows[sec.id]||[]).forEach(rid => {
      const rd = S.rowData[rid]; if (!rd) return;
      // If EUR vendor, recompute CZK from current rate
      if (rd.priceCurrency==='EUR' && rd.priceEur && rd.type==='catalog') {
        const rate = S.eurRates[rd.vendor] || 25.5;
        rd.priceCzk = rd.priceEur * rate;
        // Update display
        document.getElementById(`pczk-${rid}`)&&(document.getElementById(`pczk-${rid}`).value=fmt(rd.priceCzk)+' Kƒç');
      }
      const qty = parseInt(document.getElementById(`qty-${rid}`)?.value)||1;
      rd.qty = qty;
      const czk = rd.priceCzk || 0;
      const tot = czk * qty;
      const el = document.getElementById(`tot-${rid}`);
      if (el) el.textContent = czk>0 ? fmt(tot)+' Kƒç' : '‚Äî';
      secTot += tot;
    });
    grand += secTot;
    const el = document.getElementById(`sec-tot-${sec.id}`);
    if (el) el.textContent = fmt(secTot)+' Kƒç';
  });

  const dph = parseFloat(document.getElementById('dph-rate')?.value)||0;
  const dphAmt = grand * dph/100;
  setText('t-nodph', fmt(grand)+' Kƒç');
  setText('t-dph', fmt(dphAmt)+' Kƒç');
  setText('t-cdph', fmt(grand+dphAmt)+' Kƒç');
  setText('dph-lbl', dph);
  setText('strip-total', fmt(grand)+' Kƒç');
  S.dph = dph;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUMMARY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateSummary() {
  const allRows = document.querySelectorAll('#rows-body tr[data-rid]');
  const cat = document.querySelectorAll('#rows-body tr[data-rid][data-type!="manual"]');
  let catCnt=0, manCnt=0;
  allRows.forEach(tr => {
    const rid = tr.dataset.rid;
    if (S.rowData[rid]?.type==='manual') manCnt++; else catCnt++;
  });
  setText('cnt-cat', catCnt);
  setText('cnt-man', manCnt);
  setText('cnt-sec', S.sections.length);
  setText('item-badge', `${allRows.length} ${pl(allRows.length,'polo≈æka','polo≈æky','polo≈æek')}`);
}

function pl(n, a, b, c){ return n===1?a:n<5?b:c; }

function updateRowNumbers() {
  let n=0;
  document.querySelectorAll('#rows-body tr[data-rid]').forEach(tr => {
    n++;
    const rid = tr.dataset.rid;
    const el = document.getElementById(`rn-${rid}`);
    if (el) el.textContent = n;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRICELIST MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _plData=[], _plFiltered=[], _plPage=0;
const PL_PAGE=80;

function openPlModal(vendor) {
  // Collect all products for vendor
  _plData = [];
  const vdata = PRICELIST[vendor];
  if (!vdata) return;
  Object.entries(vdata).forEach(([series, items]) => {
    items.forEach(it => _plData.push({code:it[0],desc:it[1],color:it[2]||'',price:it[3],source:it[4],series}));
  });
  _plPage = 0;
  const isEur = S.eurRates[vendor]!==undefined;
  document.getElementById('pl-vendor-name').textContent = vendor;
  document.getElementById('pl-cnt').textContent = `${_plData.length.toLocaleString('cs')} polo≈æek${isEur?' ¬∑ ceny v EUR':''}`;
  document.getElementById('pl-search').value = '';
  _plFiltered = _plData;
  renderPlPage(vendor, isEur);
  document.getElementById('pl-modal').classList.add('open');
}

function renderPlPage(vendor, isEur) {
  isEur = isEur !== undefined ? isEur : S.eurRates[document.getElementById('pl-vendor-name').textContent]!==undefined;
  const start = _plPage * PL_PAGE;
  const slice = _plFiltered.slice(start, start+PL_PAGE);
  const tbody = document.getElementById('pl-body');
  tbody.innerHTML = '';
  slice.forEach(it => {
    const tr = document.createElement('tr');
    const cur = isEur ? '‚Ç¨' : 'Kƒç';
    tr.innerHTML = `<td class="td-code">${esc(it.code)}</td>
      <td>${esc(it.desc)}</td>
      <td style="color:#888;font-size:10.5px">${esc(it.color)}</td>
      <td style="color:#888;font-size:10.5px">${esc(it.series)}</td>
      <td class="td-price">${fmt(it.price)} ${cur}</td>
      <td style="font-size:10px;color:#aaa;font-family:monospace">${esc(it.source)}</td>`;
    tbody.appendChild(tr);
  });
  const pages = Math.ceil(_plFiltered.length/PL_PAGE);
  document.getElementById('pl-footer').textContent =
    `Zobrazeno ${start+1}‚Äì${Math.min(start+PL_PAGE, _plFiltered.length)} z ${_plFiltered.length.toLocaleString('cs')} ¬∑ strana ${_plPage+1} z ${pages} ¬∑ Pro navigaci: ‚Üê ‚Üí`;
}

document.addEventListener('keydown', e => {
  if (!document.getElementById('pl-modal').classList.contains('open')) return;
  const pages = Math.ceil(_plFiltered.length/PL_PAGE);
  if (e.key==='ArrowRight' && _plPage<pages-1) { _plPage++; renderPlPage(); }
  if (e.key==='ArrowLeft' && _plPage>0) { _plPage--; renderPlPage(); }
  if (e.key==='Escape') closePlModal();
});

let _plFilter;
function filterPl() {
  clearTimeout(_plFilter);
  _plFilter = setTimeout(() => {
    const q = document.getElementById('pl-search').value.toLowerCase().trim();
    _plFiltered = q ? _plData.filter(it=>it.code.toLowerCase().includes(q)||it.desc.toLowerCase().includes(q)||it.color.toLowerCase().includes(q)||it.series.toLowerCase().includes(q)) : _plData;
    _plPage=0; renderPlPage();
  }, 250);
}

function closePlModal(e) {
  if (e && e.target!==document.getElementById('pl-modal')) return;
  document.getElementById('pl-modal').classList.remove('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SAVE / LOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveJSON() {
  // Collect all current row data with live values from DOM
  const rowSnap = {};
  Object.entries(S.rowData).forEach(([rid, rd]) => {
    const snap = {...rd};
    snap.qty = parseInt(document.getElementById(`qty-${rid}`)?.value)||1;
    snap.note = document.getElementById(`note-${rid}`)?.value||'';
    snap.color = document.getElementById(`color-${rid}`)?.value||'';
    snap.code = document.getElementById(`code-${rid}`)?.value||'';
    snap.nazev = document.getElementById(`naz-${rid}`)?.value||'';
    if (rd.type==='catalog') {
      snap.vendor = document.getElementById(`sel-v-${rid}`)?.value||'';
      snap.series = document.getElementById(`sel-s-${rid}`)?.value||'';
      snap.product = document.getElementById(`srch-${rid}`)?.value||'';
    } else {
      snap.vendor = document.getElementById(`mvr-${rid}`)?.value||'';
      snap.series = document.getElementById(`msr-${rid}`)?.value||'';
      snap.product = document.getElementById(`mpr-${rid}`)?.value||'';
      snap.priceCzk = parseFloat(document.getElementById(`pczk-m-${rid}`)?.value)||0;
      snap.priceEur = parseFloat(document.getElementById(`peur-m-${rid}`)?.value)||null;
    }
    rowSnap[rid] = snap;
  });

  const payload = {
    version: 2, app: 'CN-cenik',
    created: new Date().toISOString(),
    projectName: document.getElementById('proj-name')?.value||'',
    dph: parseFloat(document.getElementById('dph-rate')?.value)||21,
    eurRates: {...S.eurRates},
    sections: S.sections.map(sec => ({...sec, rows: [...(S.sectionRows[sec.id]||[])]})),
    rowData: rowSnap,
    _nextSid: S._sid, _nextRid: S._rid
  };

  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  const proj = (document.getElementById('proj-name')?.value||'kalkulace').replace(/[^a-zA-Z0-9]/g,'-');
  a.download = `CN-${proj}-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  showToast('‚úì Ulo≈æeno jako JSON');
}

function loadJSON(event) {
  const file = event.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const p = JSON.parse(e.target.result);
      if (p.app !== 'CN-cenik') { alert('Neplatn√Ω soubor ‚Äì nen√≠ to CN kalkulace.'); return; }
      restoreState(p);
      showToast('‚úì Kalkulace naƒçtena');
    } catch(err) { alert('Chyba p≈ôi ƒçten√≠ souboru: '+err.message); }
    event.target.value='';
  };
  reader.readAsText(file);
}

function restoreState(p) {
  // Clear current state
  document.getElementById('rows-body').innerHTML='';
  S.sections=[]; S.sectionRows={}; S.rowData={};
  S._sid = p._nextSid||0; S._rid = p._nextRid||0;

  // Restore EUR rates
  if (p.eurRates) {
    Object.assign(S.eurRates, p.eurRates);
    Object.entries(p.eurRates).forEach(([v, rate]) => {
      const el = document.getElementById(`eur-${encodeVendor(v)}`);
      if (el) el.value = rate;
    });
  }

  // Restore project name + DPH
  const pn = document.getElementById('proj-name'); if (pn) pn.value = p.projectName||'';
  const dr = document.getElementById('dph-rate'); if (dr) dr.value = p.dph||21; S.dph = p.dph||21;

  // Restore sections + rows
  (p.sections||[]).forEach(sec => {
    S.sections.push({id:sec.id, name:sec.name});
    S.sectionRows[sec.id] = [];
    renderSectionHeader(sec.id);

    (sec.rows||[]).forEach(rid => {
      const rd = (p.rowData||{})[rid]; if (!rd) return;
      S.rowData[rid] = {...rd};
      S.sectionRows[sec.id].push(rid);

      // Render appropriate row type
      if (rd.type==='manual') {
        renderRestoredManual(rid, sec.id, rd);
      } else {
        renderRestoredCatalog(rid, sec.id, rd);
      }
    });
  });

  updateRowNumbers(); recalcAll(); updateSummary();
}

function renderRestoredCatalog(rid, sid, rd) {
  // Re-add catalog row then populate fields
  const fakeRid = S._rid; S._rid = rid; // temporarily force ID
  // Directly build row HTML
  const vendors = Object.keys(PRICELIST).sort();
  const vOpts = vendors.map(v=>`<option value="${esc(v)}"${v===rd.vendor?' selected':''}>${esc(v)}</option>`).join('');
  const nOpts = ITEM_TYPES.map(t=>`<option value="${esc(t)}"${t===rd.nazev?' selected':''}>${esc(t)}</option>`).join('');

  const tbody = document.getElementById('rows-body');
  const tr = document.createElement('tr');
  tr.id=`row-${rid}`; tr.dataset.rid=rid; tr.dataset.sid=sid;

  const isEur = rd.priceCurrency==='EUR';
  const seriesOpts = rd.vendor ? Object.keys(PRICELIST[rd.vendor]||{}).sort().map(s=>`<option value="${esc(s)}"${s===rd.series?' selected':''}>${esc(s)}</option>`).join('') : '';

  tr.innerHTML = `
    <td class="col-n"><div class="row-num" id="rn-${rid}">‚Äî</div></td>
    <td class="col-naz"><select id="naz-${rid}" onchange="S.rowData[${rid}].nazev=this.value">${nOpts}</select></td>
    <td class="col-vr"><select id="sel-v-${rid}" onchange="onVendor(${rid})">
      <option value="">‚Äî v√Ωrobce ‚Äî</option>${vOpts}</select></td>
    <td class="col-sr"><select id="sel-s-${rid}" onchange="onSeries(${rid})" ${rd.vendor?'':'disabled'}>
      <option value="">‚Äî s√©rie ‚Äî</option>${seriesOpts}</select></td>
    <td class="col-pr"><div class="search-wrap">
      <input type="text" class="search-input" id="srch-${rid}" placeholder="‚Äî v√Ωrobek ‚Äî" value="${esc(rd.product)}"
        oninput="onSearch(${rid})" onfocus="onSearch(${rid})" onblur="hideDrop(${rid})" ${rd.series?'':'disabled'} autocomplete="off"
        data-v="${esc(rd.vendor)}" data-s="${esc(rd.series)}">
      <div class="search-drop" id="drop-${rid}"></div>
    </div></td>
    <td class="col-bar"><input type="text" id="color-${rid}" placeholder="‚Äî" value="${esc(rd.color||'')}" onchange="S.rowData[${rid}].color=this.value"></td>
    <td class="col-kod"><input class="auto-fill" type="text" id="code-${rid}" value="${esc(rd.code||'')}" readonly></td>
    <td class="col-eur"><input class="auto-fill" type="text" id="peur-${rid}" value="${isEur?(fmt(rd.priceEur)+' ‚Ç¨'):'‚Äî'}" readonly></td>
    <td class="col-czk"><input class="auto-fill" type="text" id="pczk-${rid}" value="${rd.priceCzk?(fmt(rd.priceCzk)+' Kƒç'):'‚Äî'}" readonly></td>
    <td class="col-ks"><input type="number" id="qty-${rid}" value="${rd.qty||1}" min="1" onchange="S.rowData[${rid}].qty=+this.value;recalcRow(${rid})"></td>
    <td class="col-cel"><span class="line-total" id="tot-${rid}">‚Äî</span></td>
    <td class="col-kom"><textarea id="note-${rid}" onchange="S.rowData[${rid}].note=this.value">${esc(rd.note||'')}</textarea></td>
    <td class="col-src src-cell" id="src-${rid}">${esc(rd.source||'‚Äî')}</td>
    <td><button class="btn-del" onclick="deleteRow(${rid})">‚úï</button></td>`;
  tbody.appendChild(tr);
  S._rid = fakeRid;
}

function renderRestoredManual(rid, sid, rd) {
  const nOpts = ITEM_TYPES.map(t=>`<option value="${esc(t)}"${t===rd.nazev?' selected':''}>${esc(t)}</option>`).join('');
  const tbody = document.getElementById('rows-body');
  const tr = document.createElement('tr');
  tr.id=`row-${rid}`; tr.dataset.rid=rid; tr.dataset.sid=sid; tr.style.background='#fdfcf5';

  tr.innerHTML = `
    <td class="col-n"><div class="row-num m" id="rn-${rid}">‚Äî</div></td>
    <td class="col-naz"><select id="naz-${rid}" onchange="S.rowData[${rid}].nazev=this.value">${nOpts}</select></td>
    <td class="col-vr"><input type="text" id="mvr-${rid}" value="${esc(rd.vendor||'')}" placeholder="V√Ωrobce‚Ä¶" style="font-style:italic" onchange="S.rowData[${rid}].vendor=this.value"></td>
    <td class="col-sr"><input type="text" id="msr-${rid}" value="${esc(rd.series||'')}" placeholder="Kategorie‚Ä¶" style="font-style:italic" onchange="S.rowData[${rid}].series=this.value"></td>
    <td class="col-pr"><input type="text" id="mpr-${rid}" value="${esc(rd.product||'')}" placeholder="N√°zev v√Ωrobku‚Ä¶" style="font-style:italic" onchange="S.rowData[${rid}].product=this.value">
      <span class="manual-tag">Ruƒçn√≠</span></td>
    <td class="col-bar"><input type="text" id="color-${rid}" value="${esc(rd.color||'')}" placeholder="‚Äî" onchange="S.rowData[${rid}].color=this.value"></td>
    <td class="col-kod"><input type="text" id="code-${rid}" value="${esc(rd.code||'')}" placeholder="K√≥d" onchange="S.rowData[${rid}].code=this.value"></td>
    <td class="col-eur"><input type="number" id="peur-m-${rid}" value="${rd.priceEur||''}" placeholder="0" min="0" step="0.01" style="font-size:11px" onchange="onManualPrice(${rid})"></td>
    <td class="col-czk"><input type="number" id="pczk-m-${rid}" value="${rd.priceCzk||''}" placeholder="0" min="0" step="0.01" style="font-size:11px" onchange="onManualPriceCzk(${rid})"></td>
    <td class="col-ks"><input type="number" id="qty-${rid}" value="${rd.qty||1}" min="1" onchange="S.rowData[${rid}].qty=+this.value;recalcRow(${rid})"></td>
    <td class="col-cel"><span class="line-total" id="tot-${rid}">‚Äî</span></td>
    <td class="col-kom"><textarea id="note-${rid}" onchange="S.rowData[${rid}].note=this.value">${esc(rd.note||'')}</textarea></td>
    <td class="col-src src-manual" id="src-${rid}">Ruƒçn√≠ z√°pis</td>
    <td><button class="btn-del" onclick="deleteRow(${rid})">‚úï</button></td>`;
  tbody.appendChild(tr);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT XLSX (styled HTML ‚Üí .xls)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportXLSX() {
  const proj = document.getElementById('proj-name')?.value || 'Cenov√° nab√≠dka';
  const dph = parseFloat(document.getElementById('dph-rate')?.value)||21;
  const date = new Date().toLocaleDateString('cs-CZ');

  let html = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
<head><meta charset="UTF-8">
<!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet>
<x:Name>Cenov√° nab√≠dka</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions>
</x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]-->
<style>
  body{font-family:Calibri,Arial,sans-serif;font-size:11pt;}
  .hdr{background:#1a1a14;color:#c9a84c;font-weight:bold;font-size:9pt;text-transform:uppercase;}
  .sec{background:#f0ede6;font-weight:bold;font-size:11pt;color:#1a1a14;}
  .num{text-align:right;}
  .mono{font-family:'Courier New',monospace;font-size:9pt;color:#555;}
  .gold{color:#c9a84c;font-weight:bold;}
  .ttl{background:#1a1a14;color:white;font-weight:bold;text-align:right;}
  .ttl-gold{background:#c9a84c;color:#1a1a14;font-weight:bold;text-align:right;font-size:13pt;}
  .man{background:#fdfcf5;}
  td{padding:5px 8px;border:1px solid #e0ddd5;vertical-align:middle;}
  th{padding:7px 8px;border:1px solid #2a2a1e;}
  .logo-row td{background:#1a1a14;color:#c9a84c;font-size:16pt;font-weight:bold;font-family:Georgia,serif;border:none;padding:14px 16px;}
  .meta td{background:#f5f4f0;color:#888;font-size:9pt;border:none;padding:3px 16px;}
</style></head><body>
<table style="width:100%;border-collapse:collapse;margin-bottom:20px;">
  <tr class="logo-row"><td colspan="13">CN &nbsp;¬∑&nbsp; Cenov√° nab√≠dka materi√°lu</td></tr>
  <tr class="meta"><td colspan="13">Projekt: <strong style="color:#333">${esc(proj)}</strong></td></tr>
  <tr class="meta"><td colspan="13">Datum: ${date} &nbsp;|&nbsp; DPH: ${dph} %</td></tr>
  <tr><td colspan="13" style="border:none;height:8px"></td></tr>
  <tr>
    <th class="hdr">#</th><th class="hdr">N√°zev pol.</th><th class="hdr">V√Ωrobce</th>
    <th class="hdr">S√©rie</th><th class="hdr">V√Ωrobek</th><th class="hdr">Barva</th>
    <th class="hdr">K√≥d</th><th class="hdr">Cena ‚Ç¨</th><th class="hdr">Cena Kƒç/ks</th>
    <th class="hdr">Ks</th><th class="hdr">Celkem Kƒç</th><th class="hdr">Koment√°≈ô</th>
    <th class="hdr">Zdroj</th>
  </tr>`;

  let grandTotal = 0; let rowNum = 0;

  S.sections.forEach(sec => {
    let secTotal = 0;
    html += `<tr class="sec"><td colspan="13" style="background:#f0ede6;color:#1a1a14;font-weight:bold;font-size:11pt;padding:7px 10px;">${esc(sec.name)}</td></tr>`;

    (S.sectionRows[sec.id]||[]).forEach(rid => {
      const rd = S.rowData[rid]; if (!rd) return;
      rowNum++;
      const qty = parseInt(document.getElementById(`qty-${rid}`)?.value)||1;
      const czk = rd.priceCzk||0;
      const total = czk*qty;
      secTotal += total;

      const nazev = document.getElementById(`naz-${rid}`)?.value||'';
      const vendor = rd.type==='catalog' ? (document.getElementById(`sel-v-${rid}`)?.value||'') : (document.getElementById(`mvr-${rid}`)?.value||'');
      const series = rd.type==='catalog' ? (document.getElementById(`sel-s-${rid}`)?.value||'') : (document.getElementById(`msr-${rid}`)?.value||'');
      const product = rd.type==='catalog' ? (document.getElementById(`srch-${rid}`)?.value||'') : (document.getElementById(`mpr-${rid}`)?.value||'');
      const color = document.getElementById(`color-${rid}`)?.value||'';
      const code = document.getElementById(`code-${rid}`)?.value||'';
      const note = document.getElementById(`note-${rid}`)?.value||'';
      const source = document.getElementById(`src-${rid}`)?.textContent||'';
      const eurVal = rd.priceEur;
      const isMan = rd.type==='manual';

      html += `<tr${isMan?' class="man"':''}>
        <td class="num">${rowNum}</td>
        <td>${esc(nazev)}</td>
        <td>${esc(vendor)}</td>
        <td>${esc(series)}</td>
        <td>${esc(product)}</td>
        <td>${esc(color)}</td>
        <td class="mono">${esc(code)}</td>
        <td class="num">${eurVal ? fmt(eurVal)+' ‚Ç¨' : ''}</td>
        <td class="num">${czk>0?fmt(czk)+' Kƒç':''}</td>
        <td class="num">${qty}</td>
        <td class="num gold">${czk>0?fmt(total)+' Kƒç':'‚Äî'}</td>
        <td>${esc(note)}</td>
        <td class="mono" style="font-size:9pt;color:#aaa">${esc(source)}</td>
      </tr>`;
    });

    grandTotal += secTotal;
    html += `<tr><td colspan="10" style="text-align:right;background:#faf9f6;color:#888;font-size:9pt;font-style:italic">Sekce celkem: ${esc(sec.name)}</td>
      <td class="num" style="background:#faf9f6;color:#c9a84c;font-weight:bold">${fmt(secTotal)} Kƒç</td>
      <td colspan="2" style="background:#faf9f6"></td></tr>
    <tr><td colspan="13" style="border:none;height:6px"></td></tr>`;
  });

  const dphAmt = grandTotal * dph/100;
  html += `<tr><td colspan="10" class="ttl">Mezisouƒçet bez DPH</td>
    <td class="ttl" style="font-size:12pt">${fmt(grandTotal)} Kƒç</td><td colspan="2" style="background:#1a1a14;border:none"></td></tr>
  <tr><td colspan="10" class="ttl">DPH ${dph} %</td>
    <td class="ttl" style="font-size:12pt">${fmt(dphAmt)} Kƒç</td><td colspan="2" style="background:#1a1a14;border:none"></td></tr>
  <tr><td colspan="10" class="ttl-gold">CELKEM S DPH</td>
    <td class="ttl-gold" style="font-size:14pt">${fmt(grandTotal+dphAmt)} Kƒç</td><td colspan="2" style="background:#c9a84c;border:none"></td></tr>
  </table></body></html>`;

  const blob = new Blob(['\uFEFF'+html], {type:'application/vnd.ms-excel;charset=UTF-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  const projSlug = (document.getElementById('proj-name')?.value||'cenik').replace(/[^a-zA-Z0-9]/g,'-');
  a.download = `CN-${projSlug}-${new Date().toISOString().slice(0,10)}.xls`;
  a.click();
  showToast('‚úì Exportov√°no jako XLS');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function fmt(n){ return (parseFloat(n)||0).toLocaleString('cs-CZ',{minimumFractionDigits:0,maximumFractionDigits:0}); }
function setText(id,v){ const e=document.getElementById(id);if(e)e.textContent=v; }
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function showToast(msg){ const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2600); }
</script>
</body>
</html>
