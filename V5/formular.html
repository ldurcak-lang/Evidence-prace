<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CN â€“ CenovÃ¡ nabÃ­dka materiÃ¡lu</title>
<script src="data.js"></script>
<style>
/* â•â•â• RESET & BASE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*{box-sizing:border-box;margin:0;padding:0;}
:root{
  --gold:#c9a84c; --gold-h:#b8973e; --dark:#1a1a14; --dark2:#0f0f0a;
  --bg:#f5f4f0; --border:#e4e0d8; --row-h:44px;
  --font-sz:13px; --input-pad:7px 9px;
}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:#1a1a1a;min-height:100vh;display:flex;}

/* â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sidebar{width:248px;min-height:100vh;background:var(--dark);display:flex;flex-direction:column;
  flex-shrink:0;position:fixed;top:0;left:0;bottom:0;overflow-y:auto;z-index:100;
  transition:transform .25s ease;}
.sidebar.collapsed{transform:translateX(-248px);}
.sidebar-logo{padding:22px 20px 16px;border-bottom:1px solid rgba(255,255,255,.07);flex-shrink:0;}
.cn-logo{font-size:24px;font-weight:800;color:var(--gold);letter-spacing:1px;font-family:Georgia,serif;}
.cn-sub{font-size:8px;color:#4a4a38;letter-spacing:2px;text-transform:uppercase;margin-top:2px;line-height:1.5;}
.nav-label{font-size:8.5px;color:#3a3a28;letter-spacing:2.5px;text-transform:uppercase;padding:0 18px;margin:12px 0 4px;}
.nav-item{display:flex;align-items:center;gap:8px;padding:8px 18px;color:#7a7a62;font-size:13px;
  cursor:pointer;border-left:2px solid transparent;transition:all .15s;}
.nav-item:hover{color:var(--gold);background:rgba(201,168,76,.05);}
.nav-item.active{color:var(--gold);background:rgba(201,168,76,.08);border-left-color:var(--gold);font-weight:600;}
.nav-sep{height:1px;background:rgba(255,255,255,.05);margin:8px 0;}
.sb-vendor{display:flex;align-items:center;gap:6px;padding:5px 18px 5px 26px;
  color:#5a5a48;font-size:12px;cursor:pointer;transition:all .15s;border-left:2px solid transparent;}
.sb-vendor:hover{color:var(--gold);background:rgba(201,168,76,.04);}
.sv-dot{width:5px;height:5px;border-radius:50%;background:#2a2a1a;flex-shrink:0;}
.sv-dot.eur{background:var(--gold);}
.sv-cnt{margin-left:auto;font-size:9.5px;color:#3a3a28;}
.eur-section{padding:6px 14px 10px;}
.eur-row{display:flex;align-items:center;gap:6px;margin-bottom:5px;font-size:11px;color:#6a6a58;}
.eur-row label{flex:1;line-height:1.3;}
.eur-row input{width:62px;padding:3px 5px;background:#0f0f0a;border:1px solid #3a3a28;
  border-radius:4px;color:var(--gold);font-size:11px;text-align:center;font-family:monospace;}
.eur-row input:focus{outline:none;border-color:var(--gold);}

/* Sidebar toggle button */
.sb-toggle{position:fixed;top:14px;left:12px;z-index:200;width:32px;height:32px;
  background:var(--dark);border:1px solid rgba(255,255,255,.1);border-radius:7px;
  color:#7a7a62;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all .15s;}
.sb-toggle:hover{color:var(--gold);border-color:var(--gold);}
.sidebar:not(.collapsed) .sb-toggle-in{display:none;}

/* â•â•â• CONTENT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.content{margin-left:248px;flex:1;display:flex;flex-direction:column;min-height:100vh;
  transition:margin-left .25s ease;}
.content.expanded{margin-left:0;}
.topbar{background:white;border-bottom:1px solid #e8e6e0;padding:0 20px 0 52px;height:52px;
  display:flex;align-items:center;gap:8px;position:sticky;top:0;z-index:50;}
.topbar h1{font-size:14px;font-weight:800;color:var(--dark);font-family:Georgia,serif;white-space:nowrap;}
.proj-input{border:none;background:transparent;font-size:13px;color:#666;padding:3px 8px;
  border-radius:5px;min-width:200px;font-family:inherit;}
.proj-input:focus{outline:none;background:var(--bg);color:#333;}
.topbar .sp{flex:1;}
.btn{padding:6px 13px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;border:none;
  display:inline-flex;align-items:center;gap:5px;transition:all .15s;}
.btn-ghost{background:transparent;color:#666;border:1.5px solid #ddd;}
.btn-ghost:hover{border-color:var(--gold);color:var(--gold);}
.btn-gold{background:var(--gold);color:var(--dark);}
.btn-gold:hover{background:var(--gold-h);}
.btn-sm{padding:4px 10px;font-size:11.5px;}

main{padding:18px 20px;flex:1;}

/* â•â•â• SUMMARY STRIP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.strip{display:flex;align-items:center;gap:14px;margin-bottom:12px;flex-wrap:wrap;}
.stat-pill{display:flex;align-items:center;gap:5px;font-size:12.5px;color:#666;}
.dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.dot-g{background:#5aab6e;}.dot-gd{background:var(--gold);}.dot-r{background:#d44;}
.strip .sp{flex:1;}
.strip-lbl{font-size:11.5px;color:#aaa;}
.strip-tot{font-size:16px;font-weight:800;color:var(--gold);}

/* â•â•â• CARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card{background:white;border-radius:12px;border:1px solid #e8e6e0;overflow:visible;margin-bottom:12px;}
.card-hdr{padding:11px 18px;display:flex;align-items:center;gap:8px;border-bottom:1px solid #f0ede6;}
.card-hdr h2{font-size:13.5px;font-weight:700;}
.badge{background:var(--bg);color:#888;border-radius:20px;font-size:10px;padding:2px 8px;font-weight:600;}

/* â•â•â• SECTION HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sec-hdr-row{background:#f5f3ee!important;border-bottom:2px solid #e4e0d4;}
.sec-hdr-row:hover{background:#f0ede6!important;}
.sec-inner{display:flex;align-items:center;gap:8px;flex-wrap:wrap;padding:4px 0;}
.sec-name-input{border:none;background:transparent;font-size:14px;font-weight:700;color:var(--dark);
  width:200px;padding:2px 5px;border-radius:4px;font-family:inherit;}
.sec-name-input:focus{outline:none;background:white;border:1px solid var(--gold);}
.sec-tot-lbl{font-size:12px;color:#888;}
.sec-tot-lbl strong{color:var(--gold);}

/* Prvky ikonky */
.prvky-bar{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
.prvek-btn{display:flex;flex-direction:column;align-items:center;gap:3px;padding:5px 8px;
  border:1.5px solid #e0ddd5;border-radius:8px;cursor:pointer;background:white;
  transition:all .15s;min-width:56px;}
.prvek-btn:hover{border-color:var(--gold);background:#fffdf5;}
.prvek-btn svg{display:block;}
.prvek-btn span{font-size:9px;color:#888;text-transform:uppercase;letter-spacing:.5px;white-space:nowrap;}
.prvek-btn:hover span{color:var(--gold);}

.sec-btns{display:flex;gap:5px;margin-left:auto;}
.btn-sec-add{background:transparent;border:1.5px dashed #ccc;color:#aaa;padding:3px 10px;
  border-radius:5px;font-size:11.5px;cursor:pointer;white-space:nowrap;}
.btn-sec-add:hover{border-color:var(--gold);color:var(--gold);}
.btn-sec-del{background:transparent;border:none;color:#ccc;cursor:pointer;font-size:12px;
  padding:3px 7px;border-radius:4px;}
.btn-sec-del:hover{background:#fff0f0;color:#d44;}

/* â•â•â• TABLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tbl-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;}
thead tr{background:var(--dark);}
thead th{padding:9px 10px;text-align:left;font-size:9.5px;font-weight:700;color:var(--gold);
  text-transform:uppercase;letter-spacing:.7px;white-space:nowrap;}
thead th:first-child{padding-left:16px;}
thead th:last-child{padding-right:12px;}

/* DATA ROWS */
tbody tr.data-row{border-bottom:1px solid #f5f3ee;transition:background .1s;}
tbody tr.data-row:hover{background:#fdfcf9;}
tbody tr.manual-row{background:#fdfcf5;}
tbody tr.manual-row:hover{background:#faf9f0;}
td{padding:5px 8px;vertical-align:middle;}
td:first-child{padding-left:16px;}
td:last-child{padding-right:10px;}

.row-num{width:20px;height:20px;border-radius:4px;background:#f0ede6;color:#999;
  display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;flex-shrink:0;}
.row-num.m{background:#f5f0e0;color:#b08a30;}
.manual-tag{font-size:8px;font-weight:700;background:#f5f0e0;color:#b08a30;border-radius:3px;
  padding:1px 4px;letter-spacing:.5px;text-transform:uppercase;vertical-align:middle;margin-left:3px;}

/* â•â•â• INPUTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
select,input[type="number"],input[type="text"],textarea{
  width:100%;border:1.5px solid var(--border);border-radius:6px;
  padding:var(--input-pad);font-size:var(--font-sz);color:var(--dark);
  background:white;outline:none;transition:border-color .15s;font-family:inherit;}
select:focus,input:focus,textarea:focus{border-color:var(--gold);}
select{appearance:none;-webkit-appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='11' height='11' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2.5'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 7px center;padding-right:24px;cursor:pointer;}
select:disabled{opacity:.28;cursor:default;}
.auto-fill{background:#faf9f6;border-color:#eae7df;color:#555;font-family:'Courier New',monospace;font-size:12px;}
input[type="number"]{text-align:center;}
textarea{resize:none;height:36px;line-height:1.5;font-size:12.5px;color:#777;padding-top:7px;}

.line-total{font-weight:700;font-size:13px;text-align:right;display:block;white-space:nowrap;color:var(--dark);}
.btn-del{width:24px;height:24px;border:none;background:transparent;border-radius:4px;cursor:pointer;
  color:#ccc;display:flex;align-items:center;justify-content:center;font-size:13px;transition:all .15s;}
.btn-del:hover{background:#fff0f0;color:#d44;}
.btn-photo{width:24px;height:24px;border:none;background:transparent;border-radius:4px;cursor:pointer;
  color:#ccc;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all .15s;
  title:"Foto (pÅ™ipraveno pro napojenÃ­ na databÃ¡zi)";}
.btn-photo:hover{color:var(--gold);}

/* â•â•â• SEARCH DROPDOWN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.search-wrap{position:relative;}
.search-input{width:100%;border:1.5px solid var(--border);border-radius:6px;padding:var(--input-pad);
  font-size:var(--font-sz);font-family:inherit;outline:none;transition:border-color .15s;}
.search-input:focus{border-color:var(--gold);}
.search-drop{position:fixed;background:white;border:1.5px solid var(--gold);border-radius:9px;
  max-height:340px;min-width:520px;overflow-y:auto;z-index:500;
  box-shadow:0 10px 36px rgba(0,0,0,.18);display:none;}
.si{padding:9px 13px;cursor:pointer;border-bottom:1px solid #f5f3ee;line-height:1.5;}
.si:hover{background:#faf8f2;}
.si:last-child{border-bottom:none;}
.si-top{display:flex;align-items:baseline;gap:6px;}
.si-code{font-family:'Courier New',monospace;color:#777;font-size:11.5px;font-weight:600;}
.si-price{margin-left:auto;color:var(--gold);font-weight:700;font-size:13px;white-space:nowrap;}
.si-desc{color:#1a1a14;font-size:13px;font-weight:600;margin-top:1px;}
.si-meta{color:#aaa;font-size:11px;margin-top:1px;}
.si-none{padding:12px;font-size:13px;color:#999;text-align:center;}

/* Code-search mode toggle */
.mode-toggle{display:flex;gap:0;border:1.5px solid var(--border);border-radius:6px;overflow:hidden;background:white;}
.mode-btn{flex:1;padding:5px 7px;font-size:11px;font-weight:600;border:none;cursor:pointer;
  background:transparent;color:#999;transition:all .15s;white-space:nowrap;}
.mode-btn.active{background:var(--dark);color:var(--gold);}

/* â•â•â• ADD ROW BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.add-row-bar{padding:9px 18px;border-top:1px solid #f0ede6;display:flex;gap:7px;background:#fdfcfa;}
.btn-add-row{background:transparent;border:1.5px dashed #d0ccc2;color:#aaa;padding:4px 12px;
  border-radius:6px;font-size:12.5px;cursor:pointer;display:flex;align-items:center;gap:5px;transition:all .15s;}
.btn-add-row:hover{border-color:var(--gold);color:var(--gold);background:rgba(201,168,76,.04);}

/* â•â•â• FOOTER TOTALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card-footer{padding:14px 18px;border-top:2px solid #f0ede6;display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
.dph-row{display:flex;align-items:center;gap:7px;font-size:13px;color:#888;}
.dph-row input[type="number"]{width:56px;text-align:center;}
.totals{margin-left:auto;display:flex;align-items:center;gap:22px;}
.total-block{text-align:right;}
.total-block .lbl{font-size:10.5px;color:#aaa;text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px;}
.total-block .val{font-size:16px;font-weight:800;color:var(--dark);}
.total-block .val.gold{color:var(--gold);font-size:20px;}
.divider-v{width:1px;height:30px;background:#e8e6e0;}

/* â•â•â• SOURCE / PHOTO CELL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.src-cell{font-size:10px;color:#aaa;font-family:'Courier New',monospace;line-height:1.3;word-break:break-all;}
.src-manual{color:var(--gold);font-style:italic;font-family:inherit;}

/* â•â•â• COL WIDTHS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.col-n   {width:32px;}
.col-naz {min-width:130px;}
.col-vr  {min-width:120px;}
.col-sr  {min-width:115px;}
.col-pr  {min-width:200px;}
.col-bar {width:100px;}
.col-kod {width:120px;}
.col-eur {width:85px;}
.col-czk {width:88px;}
.col-ks  {width:58px;}
.col-cel {width:100px;}
.col-kom {min-width:130px;}
.col-src {width:155px;}
.col-act {width:54px;}

/* â•â•â• MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-ov{position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:900;
  display:none;align-items:flex-start;justify-content:center;padding:16px;}
.modal-ov.open{display:flex;}
.modal{background:white;border-radius:14px;width:min(1380px,97vw);max-height:95vh;
  display:flex;flex-direction:column;overflow:hidden;box-shadow:0 24px 64px rgba(0,0,0,.35);}
.modal-head{background:var(--dark);padding:16px 22px;display:flex;align-items:center;gap:10px;flex-shrink:0;}
.modal-head h2{color:var(--gold);font-size:15px;font-weight:700;font-family:Georgia,serif;}
.modal-head .cnt{color:#4a4a38;font-size:11.5px;}
.modal-head .sp{flex:1;}
.modal-close{background:transparent;border:none;color:#4a4a38;font-size:20px;cursor:pointer;padding:2px 8px;transition:color .15s;}
.modal-close:hover{color:var(--gold);}
.modal-search{padding:11px 18px;border-bottom:1px solid #f0ede6;flex-shrink:0;}
.modal-search input{width:100%;padding:8px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:13.5px;font-family:inherit;outline:none;}
.modal-search input:focus{border-color:var(--gold);}
.modal-body{overflow-y:auto;flex:1;}
.modal-body table{width:100%;border-collapse:collapse;}
.modal-body thead tr{background:var(--dark);position:sticky;top:0;z-index:1;}
.modal-body thead th{padding:9px 12px;font-size:10px;font-weight:700;color:var(--gold);
  text-transform:uppercase;letter-spacing:.6px;text-align:left;}
.modal-body tbody tr{border-bottom:1px solid #f5f3ee;}
.modal-body tbody tr:hover{background:#fdfcf9;}
.modal-body td{padding:8px 12px;font-size:12.5px;}
.td-code{font-family:'Courier New',monospace;font-size:11px;color:#666;width:120px;}
.td-price{font-weight:700;color:var(--gold);text-align:right;white-space:nowrap;width:100px;}
.modal-foot{padding:9px 18px;border-top:1px solid #f0ede6;text-align:center;font-size:11.5px;color:#aaa;flex-shrink:0;}

/* â•â•â• LOADING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#loading{position:fixed;inset:0;background:var(--dark);display:flex;flex-direction:column;
  align-items:center;justify-content:center;z-index:9999;}
.load-logo{font-size:32px;font-weight:800;color:var(--gold);letter-spacing:2px;font-family:Georgia,serif;}
.load-sub{font-size:8px;color:#3a3a28;letter-spacing:3px;text-transform:uppercase;margin:4px 0 18px;}
.load-msg{color:#5a5a48;font-size:12.5px;}
.prog{width:200px;height:2px;background:#2a2a1e;border-radius:2px;margin-top:14px;}
.prog-f{height:100%;background:var(--gold);border-radius:2px;animation:prog 1.2s ease-in-out;}
@keyframes prog{from{width:0}to{width:100%}}

/* â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast{position:fixed;bottom:20px;right:20px;background:var(--dark);color:var(--gold);
  border:1px solid var(--gold);padding:9px 16px;border-radius:8px;font-size:13px;font-weight:600;
  z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none;}
.toast.show{opacity:1;}

/* â•â•â• PRINT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media print{
  .sidebar,.topbar,.btn-del,.btn-photo,.btn-add-row,.add-row-bar,.search-drop,.toast,
  #loading,.modal-ov,.prvky-bar,.btn-sec-add,.btn-sec-del,.strip,.sb-toggle,
  .mode-toggle{display:none!important;}
  .content{margin-left:0!important;}
  body{background:white;}
  .card{border:none;border-radius:0;overflow:hidden;}
  thead tr{background:var(--dark)!important;-webkit-print-color-adjust:exact;print-color-adjust:exact;}
  thead th{color:var(--gold)!important;}
  .sec-hdr-row{background:#f0ede6!important;-webkit-print-color-adjust:exact;print-color-adjust:exact;}
  @page{margin:12mm;}
}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading">
  <div class="load-logo">CN</div>
  <div class="load-sub">CenovÃ¡ nabÃ­dka materiÃ¡lu</div>
  <div class="load-msg">NaÄÃ­tÃ¡m cenÃ­kyâ€¦</div>
  <div class="prog"><div class="prog-f"></div></div>
</div>

<!-- SIDEBAR TOGGLE -->
<button class="sb-toggle" id="sb-toggle-btn" onclick="toggleSidebar()" title="Zobrazit / skrÃ½t menu">â˜°</button>

<!-- PRICELIST MODAL -->
<div class="modal-ov" id="pl-modal" onclick="closePlModal(event)">
  <div class="modal">
    <div class="modal-head">
      <h2 id="pl-name">VÃ½robce</h2>
      <span class="cnt" id="pl-cnt"></span>
      <div class="sp"></div>
      <button class="modal-close" onclick="closePlModal()">âœ•</button>
    </div>
    <div class="modal-search">
      <input type="text" id="pl-search" placeholder="Hledat dle kÃ³du, popisu, barvy, sÃ©rieâ€¦" oninput="filterPl()">
    </div>
    <div class="modal-body">
      <table>
        <thead><tr>
          <th class="td-code">KÃ³d</th>
          <th>Popis produktu</th>
          <th style="width:110px">Barva / Povrch</th>
          <th style="width:160px">SÃ©rie</th>
          <th class="td-price">Cena</th>
          <th style="font-size:9px">Zdroj</th>
        </tr></thead>
        <tbody id="pl-body"></tbody>
      </table>
    </div>
    <div class="modal-foot" id="pl-foot"></div>
  </div>
</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <div class="cn-logo">CN</div>
    <div class="cn-sub">CenovÃ¡ nabÃ­dka<br>materiÃ¡lu</div>
  </div>
  <div style="padding:10px 0 4px;flex:1">
    <div class="nav-label">NÃ¡stroje</div>
    <div class="nav-item active">â—ˆ Kalkulace</div>
    <div class="nav-item" onclick="saveJSON()">â¬‡ UloÅ¾it (.json)</div>
    <div class="nav-item" onclick="document.getElementById('load-inp').click()">â¬† NaÄÃ­st (.json)</div>
    <input type="file" id="load-inp" accept=".json" style="display:none" onchange="loadJSON(event)">
    <div class="nav-sep"></div>
    <div class="nav-label">CenÃ­ky vÃ½robcÅ¯</div>
    <div id="vendor-nav"></div>
    <div class="nav-sep"></div>
    <div class="nav-label">Kurzy EUR â†’ KÄ</div>
    <div class="eur-section" id="eur-section"></div>
  </div>
</div>

<!-- CONTENT -->
<div class="content" id="content">
  <div class="topbar">
    <h1>CN&nbsp;Â·</h1>
    <input type="text" class="proj-input" id="proj-name" placeholder="NÃ¡zev zakÃ¡zky / projektuâ€¦">
    <div class="sp"></div>
    <button class="btn btn-ghost btn-sm" onclick="exportXLSX()">â¬‡ XLSX</button>
    <button class="btn btn-ghost btn-sm" onclick="window.print()">ğŸ–¨ PDF</button>
  </div>

  <main>
    <div class="strip">
      <div class="stat-pill"><div class="dot dot-g"></div><span id="cnt-cat">0</span> z cenÃ­ku</div>
      <div class="stat-pill"><div class="dot dot-gd"></div><span id="cnt-man">0</span> ruÄnÃ­</div>
      <div class="stat-pill"><div class="dot dot-r"></div><span id="cnt-sec">0</span> sekcÃ­</div>
      <div class="sp"></div>
      <span class="strip-lbl">MezisouÄet bez DPH&nbsp;</span>
      <span class="strip-tot" id="strip-tot">0 KÄ</span>
    </div>

    <div class="card">
      <div class="card-hdr">
        <h2>PoloÅ¾ky kalkulace</h2>
        <span class="badge" id="item-badge">0 poloÅ¾ek</span>
        <div style="flex:1"></div>
      </div>

      <div class="tbl-wrap">
        <table id="main-table">
          <thead><tr>
            <th class="col-n">#</th>
            <th class="col-naz">NÃ¡zev pol.</th>
            <th style="min-width:110px">Prvek / MÃ­stnost</th>
            <th class="col-vr">VÃ½robce</th>
            <th class="col-sr">SÃ©rie</th>
            <th class="col-pr">VÃ½robek</th>
            <th class="col-bar">Barva</th>
            <th class="col-kod">KÃ³d</th>
            <th class="col-eur">Cena â‚¬</th>
            <th class="col-czk">Cena KÄ/ks</th>
            <th class="col-ks">Ks</th>
            <th class="col-cel">Celkem KÄ</th>
            <th class="col-kom">KomentÃ¡Å™</th>
            <th class="col-src">Zdroj</th>
            <th class="col-act"></th>
          </tr></thead>
          <tbody id="rows-body"></tbody>
        </table>
      </div>

      <!-- ADD SECTION at bottom -->
      <div class="add-row-bar" id="add-sec-bar">
        <button class="btn-add-row" onclick="addSection()">ï¼‹ PÅ™idat sekci / mÃ­stnost</button>
      </div>

      <div class="card-footer">
        <div class="dph-row">
          DPH&nbsp;<input type="number" id="dph-rate" value="21" min="0" max="100" onchange="recalcAll()">&nbsp;%
        </div>
        <div class="totals">
          <div class="total-block"><div class="lbl">Bez DPH</div><div class="val" id="t-nodph">0 KÄ</div></div>
          <div class="divider-v"></div>
          <div class="total-block"><div class="lbl">DPH (<span id="dph-lbl">21</span> %)</div><div class="val" id="t-dph">0 KÄ</div></div>
          <div class="divider-v"></div>
          <div class="total-block"><div class="lbl">Celkem s DPH</div><div class="val gold" id="t-cdph">0 KÄ</div></div>
        </div>
      </div>
    </div>
  </main>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ITEM_TYPES = [
  'â€” typ poloÅ¾ky â€”',
  'Umyvadlo','WC','Bidet',
  'Baterie umyvadlovÃ¡','Baterie sprchovÃ¡','Baterie vanovÃ¡','Baterie kuchyÅˆskÃ¡',
  'Sifon','RohÃ¡Äek','Ventil','Pileta','PÅ™ipojovacÃ­ sada',
  'Vana','SprchovÃ¡ vaniÄka','SprchovÃ½ kout / zÃ¡stÄ›na','SprchovÃ½ Å¾lab',
  'RuÄnÃ­ sprcha','HlavovÃ¡ sprcha','Nohy k vanÄ›',
  'Modul WC','Modul bidet','WC mÃ­sa','WC tlaÄÃ­tko','WC prkÃ©nko','UpevnÄ›nÃ­',
  'Obklad','DlaÅ¾ba','SoklÃ­k',
  'Zrcadlo','OsvÄ›tlenÃ­',
  'KoupelnovÃ½ nÃ¡bytek','PÅ™edstÄ›novÃ½ systÃ©m / modul',
  'MontÃ¡Å¾','DoplnÄ›k / pÅ™Ã­sluÅ¡enstvÃ­','OstatnÃ­'
];

// Prvky â€“ schÃ©mata automatickÃ½ch sad poloÅ¾ek
const PRVKY = {
  umyvadlo: {
    label:'Umyvadlo', color:'#4a90d9',
    items:['Baterie umyvadlovÃ¡','Umyvadlo','Sifon','RohÃ¡Äek','Pileta']
  },
  wc: {
    label:'WC', color:'#5aab6e',
    items:['Modul WC','WC mÃ­sa','WC tlaÄÃ­tko','WC prkÃ©nko','UpevnÄ›nÃ­','PÅ™ipojovacÃ­ sada']
  },
  bidet: {
    label:'Bidet', color:'#9b6fd4',
    items:['Modul bidet','WC mÃ­sa','UpevnÄ›nÃ­','PÅ™ipojovacÃ­ sada','Pileta','Sifon','RohÃ¡Äek']
  },
  sprcha: {
    label:'Sprcha', color:'#e8843a',
    items:['Baterie sprchovÃ¡','SprchovÃ½ Å¾lab','RuÄnÃ­ sprcha','HlavovÃ¡ sprcha']
  },
  vana: {
    label:'Vana', color:'#d44b6a',
    items:['Vana','Baterie vanovÃ¡','RuÄnÃ­ sprcha','Nohy k vanÄ›','Sifon']
  }
};

// SVG icons for prvky
const PRVEK_SVG = {
  umyvadlo:`<svg width="36" height="32" viewBox="0 0 36 32" fill="none" stroke="currentColor" stroke-width="1.8">
    <path d="M5 18 Q5 28 18 28 Q31 28 31 18" stroke-linecap="round"/>
    <rect x="14" y="4" width="8" height="4" rx="1"/>
    <path d="M14 8 Q10 10 9 18" stroke-linecap="round"/>
    <path d="M22 8 Q26 10 27 18" stroke-linecap="round"/>
    <circle cx="18" cy="20" r="2"/>
  </svg>`,
  wc:`<svg width="36" height="32" viewBox="0 0 36 32" fill="none" stroke="currentColor" stroke-width="1.8">
    <rect x="10" y="2" width="16" height="8" rx="2"/>
    <path d="M8 10 Q6 26 18 28 Q30 26 28 10Z"/>
    <circle cx="18" cy="19" r="3"/>
  </svg>`,
  bidet:`<svg width="36" height="32" viewBox="0 0 36 32" fill="none" stroke="currentColor" stroke-width="1.8">
    <path d="M6 20 Q6 30 18 30 Q30 30 30 20"/>
    <path d="M10 20 Q10 12 18 12 Q26 12 26 20"/>
    <line x1="18" y1="4" x2="18" y2="12"/>
    <circle cx="18" cy="4" r="2"/>
  </svg>`,
  sprcha:`<svg width="36" height="32" viewBox="0 0 36 32" fill="none" stroke="currentColor" stroke-width="1.8">
    <path d="M8 8 Q8 2 18 2 Q28 2 28 8" stroke-linecap="round"/>
    <path d="M18 2 L18 12" stroke-linecap="round"/>
    <circle cx="18" cy="14" r="3"/>
    <path d="M12 20 L12 28 M16 18 L14 28 M20 18 L22 28 M24 20 L24 28" stroke-linecap="round"/>
  </svg>`,
  vana:`<svg width="36" height="32" viewBox="0 0 36 32" fill="none" stroke="currentColor" stroke-width="1.8">
    <path d="M4 18 L4 24 Q4 28 8 28 L28 28 Q32 28 32 24 L32 18 Z"/>
    <line x1="4" y1="18" x2="32" y2="18"/>
    <path d="M4 18 L4 10 Q4 4 10 4 Q14 4 14 8 L14 18"/>
    <circle cx="10" cy="8" r="2"/>
    <line x1="8" y1="28" x2="8" y2="30" stroke-linecap="round"/>
    <line x1="28" y1="28" x2="28" y2="30" stroke-linecap="round"/>
  </svg>`
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
  sections:[],       // [{id,name}]
  rowData:{},        // rid->{type,secId,nazev,prvek,...}
  secRows:{},        // secId->[rid,...]
  eurRates:{},       // vendor->rate
  dph:21,
  _sid:0, _rid:0,
  sid(){ return ++this._sid; },
  rid(){ return ++this._rid; }
};

// Global product index for code search: code -> [{vendor,series,item}]
let CODE_INDEX = {};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    buildCodeIndex();
    initEurRates();
    buildSidebar();
    document.getElementById('loading').style.display = 'none';
    addSection('MÃ­stnost 1');
  }, 600);
});

function buildCodeIndex() {
  Object.entries(PRICELIST).forEach(([vendor, series]) => {
    Object.entries(series).forEach(([ser, items]) => {
      items.forEach(it => {
        const code = String(it[0]).toUpperCase();
        if (!CODE_INDEX[code]) CODE_INDEX[code] = [];
        CODE_INDEX[code].push({vendor, series:ser, item:it});
      });
    });
  });
}

function initEurRates() {
  if (typeof PRICE_CURRENCY !== 'undefined') {
    Object.keys(PRICE_CURRENCY).forEach(v => {
      if (PRICE_CURRENCY[v] === 'EUR') S.eurRates[v] = 25.50;
    });
  }
}

function buildSidebar() {
  // Vendor list
  const nav = document.getElementById('vendor-nav');
  Object.keys(PRICELIST).sort().forEach(v => {
    const cnt = Object.values(PRICELIST[v]).reduce((a,b)=>a+b.length, 0);
    const isEur = S.eurRates[v] !== undefined;
    const d = document.createElement('div');
    d.className = 'sb-vendor';
    d.innerHTML = `<div class="sv-dot${isEur?' eur':''}"></div>
      <span style="flex:1">${esc(v)}</span>
      <span class="sv-cnt">${cnt.toLocaleString('cs')}</span>`;
    d.onclick = () => openPlModal(v);
    nav.appendChild(d);
  });
  // EUR rates
  const eur = document.getElementById('eur-section');
  const ev = Object.keys(S.eurRates);
  if (!ev.length) { eur.innerHTML='<div style="font-size:10.5px;color:#3a3a28;padding:4px 0">Å½Ã¡dnÃ© EUR cenÃ­ky</div>'; return; }
  ev.forEach(v => {
    const key = ev2key(v);
    const d = document.createElement('div');
    d.className = 'eur-row';
    d.innerHTML = `<label>${esc(v.length>18?v.substring(0,16)+'â€¦':v)}<br><small style="color:#3a3a28;font-size:9px">EUR â†’ KÄ kurz</small></label>
      <input type="number" id="eur-${key}" value="${S.eurRates[v]}" min="1" max="99" step="0.01"
        onchange="setEurRate('${esc(v)}','${key}')">`;
    eur.appendChild(d);
  });
}

function ev2key(v){ return v.replace(/[^a-zA-Z0-9]/g,'_'); }

function setEurRate(vendor, key) {
  const val = parseFloat(document.getElementById(`eur-${key}`)?.value) || 25.5;
  S.eurRates[vendor] = val;
  recalcAll();
  showToast(`Kurz ${vendor}: ${val} KÄ/â‚¬`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIDEBAR TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSidebar() {
  const sb = document.getElementById('sidebar');
  const ct = document.getElementById('content');
  sb.classList.toggle('collapsed');
  ct.classList.toggle('expanded');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SECTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addSection(name) {
  const sid = S.sid();
  S.sections.push({id:sid, name: name || `MÃ­stnost ${sid}`});
  S.secRows[sid] = [];
  renderSecHeader(sid);
  // Move the "add section" bar to the end always
  const bar = document.getElementById('add-sec-bar');
  document.getElementById('rows-body').after(bar); // keep outside table
  updateSummary();
}

function renderSecHeader(sid) {
  const sec = S.sections.find(s=>s.id===sid);
  const tbody = document.getElementById('rows-body');
  const tr = document.createElement('tr');
  tr.className = 'sec-hdr-row'; tr.id = `sec-${sid}`;

  // Build prvky buttons
  let prvkyHTML = '';
  Object.entries(PRVKY).forEach(([key, p]) => {
    prvkyHTML += `<button class="prvek-btn" onclick="addPrvek(${sid},'${key}')" title="PÅ™idat ${p.label}" style="color:${p.color}">
      ${PRVEK_SVG[key]}<span>${p.label}</span></button>`;
  });

  tr.innerHTML = `<td colspan="15">
    <div class="sec-inner">
      <input class="sec-name-input" value="${esc(sec.name)}" placeholder="NÃ¡zev sekceâ€¦"
        onchange="S.sections.find(s=>s.id===${sid}).name=this.value;recalcAll()">
      <span class="sec-tot-lbl">Celkem:&nbsp;<strong id="st-${sid}">0 KÄ</strong></span>
      <div class="prvky-bar">${prvkyHTML}</div>
      <div class="sec-btns">
        <button class="btn-sec-add" onclick="addRow(${sid},'catalog')">ï¼‹ Z cenÃ­ku</button>
        <button class="btn-sec-add" onclick="addRow(${sid},'manual')">âœ RuÄnÄ›</button>
        <button class="btn-sec-del" onclick="delSection(${sid})">âœ• sekce</button>
      </div>
    </div>
  </td>`;
  tbody.appendChild(tr);
}

function delSection(sid) {
  if (!confirm('Smazat sekci a vÅ¡echny jejÃ­ Å™Ã¡dky?')) return;
  (S.secRows[sid]||[]).forEach(rid => { document.getElementById(`row-${rid}`)?.remove(); delete S.rowData[rid]; });
  document.getElementById(`sec-${sid}`)?.remove();
  S.sections = S.sections.filter(s=>s.id!==sid);
  delete S.secRows[sid];
  updateRowNums(); recalcAll(); updateSummary();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRVKY â€“ auto-add rows
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addPrvek(sid, key) {
  const p = PRVKY[key];
  if (!p) return;
  p.items.forEach(itemType => {
    const rid = addRow(sid, 'catalog', false); // false = don't trigger recalc yet
    // pre-fill item type
    const nazEl = document.getElementById(`naz-${rid}`);
    if (nazEl) {
      const found = ITEM_TYPES.find(t => t.toLowerCase() === itemType.toLowerCase());
      if (found) nazEl.value = found;
      S.rowData[rid].nazev = nazEl.value;
    }
    // Colour the row lightly with prvek color
    const tr = document.getElementById(`row-${rid}`);
    if (tr) tr.style.borderLeft = `3px solid ${p.color}`;
  });
  recalcAll(); updateSummary();
  showToast(`âœ“ PÅ™idÃ¡ny poloÅ¾ky: ${p.label}`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD ROW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addRow(sid, type, doRecalc=true) {
  if (!sid) { sid = S.sections[S.sections.length-1]?.id; if(!sid){addSection();return;} }
  const rid = S.rid();
  S.secRows[sid].push(rid);
  S.rowData[rid] = {type, secId:sid, nazev:'', vendor:'', series:'', product:'',
    code:'', priceNative:0, priceCurrency:'CZK', priceEur:null, priceCzk:0,
    color:'', qty:1, note:'', source:''};

  const nOpts = ITEM_TYPES.map(t=>`<option value="${esc(t)}">${esc(t)}</option>`).join('');
  const vOpts = Object.keys(PRICELIST).sort().map(v=>`<option value="${esc(v)}">${esc(v)}</option>`).join('');

  // Find section header row in tbody, insert BEFORE next section header (or end)
  const tbody = document.getElementById('rows-body');
  const secEl = document.getElementById(`sec-${sid}`);
  // Find the next section header after this one
  let insertBefore = null;
  let found = false;
  for (const tr of tbody.querySelectorAll('tr')) {
    if (found && tr.classList.contains('sec-hdr-row')) { insertBefore = tr; break; }
    if (tr.id === `sec-${sid}`) found = true;
  }

  const tr = document.createElement('tr');
  tr.id = `row-${rid}`;
  tr.dataset.rid = rid;
  tr.dataset.sid = sid;
  tr.className = type === 'manual' ? 'data-row manual-row' : 'data-row';

  if (type === 'catalog') {
    tr.innerHTML = buildCatalogRowHTML(rid, nOpts, vOpts);
  } else {
    tr.innerHTML = buildManualRowHTML(rid, nOpts);
  }

  if (insertBefore) tbody.insertBefore(tr, insertBefore);
  else tbody.appendChild(tr);

  if (doRecalc) { updateRowNums(); recalcAll(); updateSummary(); }
  return rid;
}

function buildCatalogRowHTML(rid, nOpts, vOpts) {
  return `
    <td class="col-n"><div class="row-num" id="rn-${rid}">â€”</div></td>
    <td class="col-naz"><select id="naz-${rid}" onchange="S.rowData[${rid}].nazev=this.value">${nOpts}</select></td>
    <td style="min-width:110px">
      <div class="mode-toggle">
        <button class="mode-btn active" id="mb-vr-${rid}" onclick="setMode(${rid},'vendor')">VÃ½robce</button>
        <button class="mode-btn" id="mb-cd-${rid}" onclick="setMode(${rid},'code')">KÃ³d</button>
      </div>
    </td>
    <td class="col-vr" id="td-vr-${rid}">
      <select id="sel-v-${rid}" onchange="onVendor(${rid})">
        <option value="">â€” vÃ½robce â€”</option>${vOpts}</select></td>
    <td class="col-sr" id="td-sr-${rid}">
      <select id="sel-s-${rid}" onchange="onSeries(${rid})" disabled>
        <option value="">â€” sÃ©rie â€”</option></select></td>
    <td class="col-pr">
      <div class="search-wrap">
        <input type="text" class="search-input" id="srch-${rid}" placeholder="â€” vÃ½robek â€”"
          oninput="onSearch(${rid})" onfocus="onSearch(${rid})" onblur="hideDrop(${rid})"
          disabled autocomplete="off">
        <div class="search-drop" id="drop-${rid}"></div>
      </div>
    </td>
    <td class="col-bar"><input type="text" id="color-${rid}" placeholder="â€”" onchange="S.rowData[${rid}].color=this.value"></td>
    <td class="col-kod"><input class="auto-fill" type="text" id="code-${rid}" placeholder="â€”" readonly></td>
    <td class="col-eur"><input class="auto-fill" type="text" id="peur-${rid}" placeholder="â€”" readonly></td>
    <td class="col-czk"><input class="auto-fill" type="text" id="pczk-${rid}" placeholder="â€”" readonly></td>
    <td class="col-ks"><input type="number" id="qty-${rid}" value="1" min="1" onchange="S.rowData[${rid}].qty=+this.value;recalcRow(${rid})"></td>
    <td class="col-cel"><span class="line-total" id="tot-${rid}">â€”</span></td>
    <td class="col-kom"><textarea id="note-${rid}" placeholder="PoznÃ¡mkaâ€¦" onchange="S.rowData[${rid}].note=this.value"></textarea></td>
    <td class="col-src src-cell" id="src-${rid}">â€”</td>
    <td class="col-act">
      <div style="display:flex;gap:3px;align-items:center">
        <button class="btn-photo" title="Foto produktu (pÅ™ipraveno pro napojenÃ­ na databÃ¡zi)">ğŸ“·</button>
        <button class="btn-del" onclick="delRow(${rid})">âœ•</button>
      </div>
    </td>`;
}

function buildManualRowHTML(rid, nOpts) {
  return `
    <td class="col-n"><div class="row-num m" id="rn-${rid}">â€”</div></td>
    <td class="col-naz"><select id="naz-${rid}" onchange="S.rowData[${rid}].nazev=this.value">${nOpts}</select></td>
    <td><span class="manual-tag">RuÄnÃ­</span></td>
    <td class="col-vr"><input type="text" id="sel-v-${rid}" placeholder="VÃ½robceâ€¦" style="font-style:italic" onchange="S.rowData[${rid}].vendor=this.value"></td>
    <td class="col-sr"><input type="text" id="sel-s-${rid}" placeholder="Kategorieâ€¦" style="font-style:italic" onchange="S.rowData[${rid}].series=this.value"></td>
    <td class="col-pr"><input type="text" id="srch-${rid}" placeholder="NÃ¡zev vÃ½robkuâ€¦" style="font-style:italic" onchange="S.rowData[${rid}].product=this.value"></td>
    <td class="col-bar"><input type="text" id="color-${rid}" placeholder="â€”" onchange="S.rowData[${rid}].color=this.value"></td>
    <td class="col-kod"><input type="text" id="code-${rid}" placeholder="KÃ³d" onchange="S.rowData[${rid}].code=this.value"></td>
    <td class="col-eur"><input type="number" id="peur-m-${rid}" placeholder="0 â‚¬" min="0" step="0.01" onchange="onManualEur(${rid})" style="font-size:12px"></td>
    <td class="col-czk"><input type="number" id="pczk-m-${rid}" placeholder="0 KÄ" min="0" step="1" onchange="onManualCzk(${rid})" style="font-size:12px"></td>
    <td class="col-ks"><input type="number" id="qty-${rid}" value="1" min="1" onchange="S.rowData[${rid}].qty=+this.value;recalcRow(${rid})"></td>
    <td class="col-cel"><span class="line-total" id="tot-${rid}">â€”</span></td>
    <td class="col-kom"><textarea id="note-${rid}" placeholder="PoznÃ¡mkaâ€¦" onchange="S.rowData[${rid}].note=this.value"></textarea></td>
    <td class="col-src src-manual" id="src-${rid}">RuÄnÃ­</td>
    <td class="col-act">
      <div style="display:flex;gap:3px;align-items:center">
        <button class="btn-photo" title="Foto produktu (pÅ™ipraveno pro napojenÃ­ na databÃ¡zi)">ğŸ“·</button>
        <button class="btn-del" onclick="delRow(${rid})">âœ•</button>
      </div>
    </td>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODE TOGGLE (VÃ½robce / KÃ³d)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setMode(rid, mode) {
  const mbVr = document.getElementById(`mb-vr-${rid}`);
  const mbCd = document.getElementById(`mb-cd-${rid}`);
  const tdVr = document.getElementById(`td-vr-${rid}`);
  const tdSr = document.getElementById(`td-sr-${rid}`);
  const srch = document.getElementById(`srch-${rid}`);

  if (mode === 'code') {
    mbVr.classList.remove('active'); mbCd.classList.add('active');
    // Swap vendor+series cells to a code search input
    tdVr.innerHTML = `<input type="text" id="codesrch-${rid}" placeholder="Zadejte kÃ³dâ€¦"
      oninput="onCodeSearch(${rid})" onfocus="onCodeSearch(${rid})" onblur="hideDrop(${rid})"
      autocomplete="off" style="font-family:'Courier New',monospace;font-size:12.5px">
      <div class="search-drop" id="drop-${rid}"></div>`;
    tdSr.innerHTML = '';
    srch.disabled = true; srch.value = '';
    clearFill(rid);
    S.rowData[rid]._mode = 'code';
  } else {
    mbVr.classList.add('active'); mbCd.classList.remove('active');
    const vOpts = Object.keys(PRICELIST).sort().map(v=>`<option value="${esc(v)}">${esc(v)}</option>`).join('');
    tdVr.innerHTML = `<select id="sel-v-${rid}" onchange="onVendor(${rid})"><option value="">â€” vÃ½robce â€”</option>${vOpts}</select>`;
    tdSr.innerHTML = `<select id="sel-s-${rid}" onchange="onSeries(${rid})" disabled><option value="">â€” sÃ©rie â€”</option></select>`;
    srch.disabled = true; srch.value = '';
    clearFill(rid);
    S.rowData[rid]._mode = 'vendor';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CODE SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _cst = {};
function onCodeSearch(rid) {
  clearTimeout(_cst[rid]);
  _cst[rid] = setTimeout(() => {
    const el = document.getElementById(`codesrch-${rid}`);
    if (!el) return;
    const q = el.value.trim().toUpperCase();
    const drop = document.getElementById(`drop-${rid}`);
    drop.innerHTML = '';
    if (q.length < 2) { drop.style.display='none'; return; }

    // Find matches
    const matches = [];
    Object.entries(PRICELIST).forEach(([vendor, series]) => {
      Object.entries(series).forEach(([ser, items]) => {
        items.forEach(it => {
          if (String(it[0]).toUpperCase().includes(q)) {
            matches.push({vendor, series:ser, item:it});
          }
        });
      });
    });

    if (!matches.length) { drop.innerHTML='<div class="si-none">KÃ³d nenalezen</div>'; }
    else {
      matches.slice(0,60).forEach(m => {
        const isEur = S.eurRates[m.vendor] !== undefined;
        const cur = isEur ? 'â‚¬' : 'KÄ';
        const d = document.createElement('div');
        d.className = 'si';
        d.innerHTML = `<div class="si-top">
          <span class="si-code">${esc(m.item[0])}</span>
          <span class="si-meta">${esc(m.vendor)}</span>
          <span class="si-price">${fmt(m.item[3])} ${cur}</span></div>
          <div class="si-desc">${esc(m.item[1])}</div>
          ${m.item[2]?`<div class="si-meta">${esc(m.item[2])}</div>`:''}`;
        d.addEventListener('mousedown', e => { e.preventDefault(); selectProduct(rid, m.vendor, m.item); el.value = m.item[0]; });
        drop.appendChild(d);
      });
    }
    positionDrop(rid, document.getElementById(`codesrch-${rid}`));
    drop.style.display = 'block';
  }, 200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VENDOR/SERIES SELECT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onVendor(rid) {
  const v = document.getElementById(`sel-v-${rid}`)?.value;
  S.rowData[rid].vendor = v || '';
  const ss = document.getElementById(`sel-s-${rid}`);
  const srch = document.getElementById(`srch-${rid}`);
  ss.innerHTML = '<option value="">â€” sÃ©rie â€”</option>';
  ss.disabled = !v; srch.disabled = true; srch.value = '';
  clearFill(rid);
  if (!v) return;
  Object.keys(PRICELIST[v]).sort().forEach(s => { const o=document.createElement('option');o.value=s;o.textContent=s;ss.appendChild(o); });
  if (Object.keys(PRICELIST[v]).length === 1) { ss.value=Object.keys(PRICELIST[v])[0]; onSeries(rid); }
}

function onSeries(rid) {
  const v = document.getElementById(`sel-v-${rid}`)?.value;
  const s = document.getElementById(`sel-s-${rid}`)?.value;
  S.rowData[rid].series = s || '';
  const srch = document.getElementById(`srch-${rid}`);
  srch.disabled = !s; srch.value = '';
  srch.dataset.v = v; srch.dataset.s = s;
  srch.placeholder = s ? `Hledat v ${s.substring(0,22)}â€¦` : 'â€” vÃ½robek â€”';
  clearFill(rid);
}

let _st = {};
function onSearch(rid) {
  const srch = document.getElementById(`srch-${rid}`);
  if (!srch || srch.disabled) return;
  clearTimeout(_st[rid]);
  _st[rid] = setTimeout(() => {
    const v=srch.dataset.v, s=srch.dataset.s, q=srch.value.toLowerCase().trim();
    if (!v||!s) return;
    const items = PRICELIST[v]?.[s] || [];
    const filtered = q
      ? items.filter(it=>it[0].toLowerCase().includes(q)||it[1].toLowerCase().includes(q)||(it[2]&&it[2].toLowerCase().includes(q)))
      : items;
    const drop = document.getElementById(`drop-${rid}`);
    drop.innerHTML = '';
    const top = filtered.slice(0, 100);
    if (!top.length) { drop.innerHTML='<div class="si-none">Nic nenalezeno</div>'; }
    else {
      const isEur = S.eurRates[v] !== undefined;
      const cur = isEur ? 'â‚¬' : 'KÄ';
      top.forEach(it => {
        const d=document.createElement('div'); d.className='si';
        d.innerHTML=`<div class="si-top">
          <span class="si-code">${esc(it[0])}</span>
          ${it[2]?`<span class="si-meta">${esc(it[2])}</span>`:''}
          <span class="si-price">${fmt(it[3])} ${cur}</span></div>
          <div class="si-desc">${esc(it[1])}</div>`;
        d.addEventListener('mousedown', e=>{e.preventDefault();selectProduct(rid,v,it);});
        drop.appendChild(d);
      });
    }
    positionDrop(rid, srch);
    drop.style.display = 'block';
  }, 180);
}

function positionDrop(rid, anchorEl) {
  const drop = document.getElementById(`drop-${rid}`);
  if (!anchorEl||!drop) return;
  const r = anchorEl.getBoundingClientRect();
  const below = window.innerHeight - r.bottom - 8;
  const above = r.top - 8;
  const h = Math.min(340, Math.max(below, above));
  drop.style.maxHeight = h+'px';
  drop.style.left = r.left+'px';
  drop.style.width = Math.max(520, r.width)+'px';
  if (below >= 160 || below >= above) {
    drop.style.top=(r.bottom+3)+'px'; drop.style.bottom='auto';
  } else {
    drop.style.bottom=(window.innerHeight-r.top+3)+'px'; drop.style.top='auto';
  }
}

function hideDrop(rid){ setTimeout(()=>{ const d=document.getElementById(`drop-${rid}`); if(d)d.style.display='none'; }, 220); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SELECT PRODUCT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectProduct(rid, vendor, it) {
  const isEur = S.eurRates[vendor] !== undefined;
  const rate = S.eurRates[vendor] || 25.5;
  const priceNative = parseFloat(it[3])||0;
  const priceEur = isEur ? priceNative : null;
  const priceCzk = isEur ? priceNative * rate : priceNative;

  Object.assign(S.rowData[rid], {
    vendor, product:it[1], code:it[0], color:it[2]||'',
    priceNative, priceCurrency:isEur?'EUR':'CZK', priceEur, priceCzk, source:it[4]
  });

  const srch = document.getElementById(`srch-${rid}`);
  if (srch) srch.value = it[1];
  setVal(`code-${rid}`, it[0]);
  setVal(`color-${rid}`, it[2]||'');
  setVal(`peur-${rid}`, isEur ? fmt(priceNative)+' â‚¬' : 'â€”');
  setVal(`pczk-${rid}`, fmt(priceCzk)+' KÄ');
  const srcEl = document.getElementById(`src-${rid}`);
  if (srcEl) srcEl.textContent = it[4];
  hideDrop(rid);
  recalcRow(rid);
}

function clearFill(rid) {
  setVal(`code-${rid}`,''); setVal(`peur-${rid}`,''); setVal(`pczk-${rid}`,'');
  const s=document.getElementById(`src-${rid}`); if(s)s.textContent='â€”';
  const t=document.getElementById(`tot-${rid}`); if(t)t.textContent='â€”';
  Object.assign(S.rowData[rid]||{},{priceNative:0,priceEur:null,priceCzk:0});
  recalcAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MANUAL PRICE INPUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onManualEur(rid) {
  const eur = parseFloat(document.getElementById(`peur-m-${rid}`)?.value)||0;
  const rate = Object.values(S.eurRates)[0] || 25.5;
  S.rowData[rid].priceEur = eur||null;
  S.rowData[rid].priceCurrency = eur ? 'EUR' : 'CZK';
  if (eur) {
    const czk = eur * rate;
    S.rowData[rid].priceCzk = czk;
    const el = document.getElementById(`pczk-m-${rid}`);
    if (el) el.value = czk.toFixed(0);
  }
  recalcRow(rid);
}

function onManualCzk(rid) {
  const czk = parseFloat(document.getElementById(`pczk-m-${rid}`)?.value)||0;
  S.rowData[rid].priceCzk = czk; S.rowData[rid].priceNative = czk;
  S.rowData[rid].priceCurrency = 'CZK';
  recalcRow(rid);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DELETE ROW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function delRow(rid) {
  const sid = S.rowData[rid]?.secId;
  document.getElementById(`row-${rid}`)?.remove();
  delete S.rowData[rid];
  if (sid && S.secRows[sid]) S.secRows[sid] = S.secRows[sid].filter(r=>r!==rid);
  updateRowNums(); recalcAll(); updateSummary();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RECALC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function recalcRow(rid) {
  const rd = S.rowData[rid]; if (!rd) return;
  const qty = parseInt(document.getElementById(`qty-${rid}`)?.value)||1;
  rd.qty = qty;
  // Re-apply EUR rate if needed
  if (rd.priceCurrency==='EUR' && rd.priceEur && rd.type==='catalog') {
    rd.priceCzk = rd.priceEur * (S.eurRates[rd.vendor]||25.5);
    setVal(`pczk-${rid}`, fmt(rd.priceCzk)+' KÄ');
  }
  const czk = rd.priceCzk||0;
  const el = document.getElementById(`tot-${rid}`);
  if (el) el.textContent = czk>0 ? fmt(czk*qty)+' KÄ' : 'â€”';
  recalcAll();
}

function recalcAll() {
  let grand = 0;
  S.sections.forEach(sec => {
    let secTot = 0;
    (S.secRows[sec.id]||[]).forEach(rid => {
      const rd = S.rowData[rid]; if(!rd) return;
      // Re-apply EUR rate for catalog rows
      if (rd.priceCurrency==='EUR' && rd.priceEur && rd.type==='catalog') {
        rd.priceCzk = rd.priceEur * (S.eurRates[rd.vendor]||25.5);
        setVal(`pczk-${rid}`, fmt(rd.priceCzk)+' KÄ');
      }
      const qty = parseInt(document.getElementById(`qty-${rid}`)?.value)||1;
      rd.qty = qty;
      const czk = rd.priceCzk||0;
      const tot = czk*qty;
      const el = document.getElementById(`tot-${rid}`);
      if (el) el.textContent = czk>0 ? fmt(tot)+' KÄ' : 'â€”';
      secTot += tot;
    });
    grand += secTot;
    setText(`st-${sec.id}`, fmt(secTot)+' KÄ');
  });
  const dph = parseFloat(document.getElementById('dph-rate')?.value)||0;
  S.dph = dph;
  setText('t-nodph', fmt(grand)+' KÄ');
  setText('t-dph', fmt(grand*dph/100)+' KÄ');
  setText('t-cdph', fmt(grand+grand*dph/100)+' KÄ');
  setText('dph-lbl', dph);
  setText('strip-tot', fmt(grand)+' KÄ');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUMMARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateSummary() {
  let cat=0, man=0;
  Object.values(S.rowData).forEach(rd => { if(rd.type==='manual') man++; else cat++; });
  setText('cnt-cat', cat); setText('cnt-man', man); setText('cnt-sec', S.sections.length);
  const total = cat+man;
  setText('item-badge', `${total} ${total===1?'poloÅ¾ka':total<5?'poloÅ¾ky':'poloÅ¾ek'}`);
}

function updateRowNums() {
  let n=0;
  document.querySelectorAll('#rows-body tr[data-rid]').forEach(tr => {
    n++;
    const el = document.getElementById(`rn-${tr.dataset.rid}`);
    if (el) el.textContent = n;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRICELIST MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _plAll=[], _plFilt=[], _plPage=0;
const PL_PG=100;

function openPlModal(vendor) {
  _plAll=[];
  Object.entries(PRICELIST[vendor]||{}).forEach(([ser,items])=>{
    items.forEach(it=>_plAll.push({code:it[0],desc:it[1],color:it[2]||'',price:it[3],source:it[4],series:ser}));
  });
  _plFilt=[..._plAll]; _plPage=0;
  const isEur=S.eurRates[vendor]!==undefined;
  setText('pl-name', vendor);
  setText('pl-cnt', `${_plAll.length.toLocaleString('cs')} poloÅ¾ek${isEur?' Â· EUR':''}`);
  document.getElementById('pl-search').value='';
  renderPlPage(isEur);
  document.getElementById('pl-modal').classList.add('open');
}

function renderPlPage(isEur) {
  isEur = isEur !== undefined ? isEur : false;
  const start=_plPage*PL_PG;
  const slice=_plFilt.slice(start, start+PL_PG);
  const tbody=document.getElementById('pl-body');
  tbody.innerHTML='';
  const cur=isEur?'â‚¬':'KÄ';
  slice.forEach(it=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="td-code">${esc(it.code)}</td>
      <td>${esc(it.desc)}</td>
      <td style="color:#888;font-size:11.5px">${esc(it.color)}</td>
      <td style="color:#888;font-size:11.5px">${esc(it.series)}</td>
      <td class="td-price">${fmt(it.price)} ${cur}</td>
      <td style="font-size:10px;color:#aaa;font-family:monospace">${esc(it.source)}</td>`;
    tbody.appendChild(tr);
  });
  const pages=Math.ceil(_plFilt.length/PL_PG);
  setText('pl-foot', `${start+1}â€“${Math.min(start+PL_PG,_plFilt.length)} z ${_plFilt.length.toLocaleString('cs')} Â· strana ${_plPage+1}/${pages} Â· â† â†’ pro navigaci`);
}

document.addEventListener('keydown', e => {
  if (!document.getElementById('pl-modal').classList.contains('open')) return;
  const vendor = document.getElementById('pl-name').textContent;
  const isEur = S.eurRates[vendor]!==undefined;
  const pages=Math.ceil(_plFilt.length/PL_PG);
  if(e.key==='ArrowRight'&&_plPage<pages-1){_plPage++;renderPlPage(isEur);}
  if(e.key==='ArrowLeft'&&_plPage>0){_plPage--;renderPlPage(isEur);}
  if(e.key==='Escape') closePlModal();
});

let _plFT;
function filterPl() {
  clearTimeout(_plFT);
  _plFT = setTimeout(()=>{
    const q=document.getElementById('pl-search').value.toLowerCase().trim();
    const vendor=document.getElementById('pl-name').textContent;
    const isEur=S.eurRates[vendor]!==undefined;
    _plFilt=q?_plAll.filter(it=>it.code.toLowerCase().includes(q)||it.desc.toLowerCase().includes(q)||it.color.toLowerCase().includes(q)||it.series.toLowerCase().includes(q)):_plAll;
    _plPage=0; renderPlPage(isEur);
  },250);
}

function closePlModal(e) {
  if (e&&e.target!==document.getElementById('pl-modal')) return;
  document.getElementById('pl-modal').classList.remove('open');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE / LOAD JSON
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveJSON() {
  const snap={};
  Object.entries(S.rowData).forEach(([rid,rd])=>{
    const s={...rd};
    s.qty=parseInt(document.getElementById(`qty-${rid}`)?.value)||1;
    s.note=document.getElementById(`note-${rid}`)?.value||'';
    s.color=document.getElementById(`color-${rid}`)?.value||'';
    s.code=document.getElementById(`code-${rid}`)?.value||'';
    s.nazev=document.getElementById(`naz-${rid}`)?.value||'';
    if(rd.type==='catalog'){
      s.product=document.getElementById(`srch-${rid}`)?.value||'';
      s.vendor=document.getElementById(`sel-v-${rid}`)?.value||rd.vendor||'';
      s.series=document.getElementById(`sel-s-${rid}`)?.value||rd.series||'';
    } else {
      s.vendor=document.getElementById(`sel-v-${rid}`)?.value||'';
      s.series=document.getElementById(`sel-s-${rid}`)?.value||'';
      s.product=document.getElementById(`srch-${rid}`)?.value||'';
      s.priceCzk=parseFloat(document.getElementById(`pczk-m-${rid}`)?.value)||rd.priceCzk||0;
      s.priceEur=parseFloat(document.getElementById(`peur-m-${rid}`)?.value)||null;
    }
    snap[rid]=s;
  });
  const payload={
    version:3, app:'CN-cenik', created:new Date().toISOString(),
    projectName:document.getElementById('proj-name')?.value||'',
    dph:parseFloat(document.getElementById('dph-rate')?.value)||21,
    eurRates:{...S.eurRates},
    sections:S.sections.map(sec=>({...sec,rows:[...(S.secRows[sec.id]||[])]})),
    rowData:snap, _sid:S._sid, _rid:S._rid
  };
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  const p=(document.getElementById('proj-name')?.value||'kalkulace').replace(/[^a-zA-Z0-9]/g,'-');
  a.download=`CN-${p}-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  showToast('âœ“ UloÅ¾eno');
}

function loadJSON(ev) {
  const file=ev.target.files[0]; if(!file) return;
  const r=new FileReader();
  r.onload=e=>{
    try{
      const p=JSON.parse(e.target.result);
      if(p.app!=='CN-cenik'){alert('NeplatnÃ½ soubor.');return;}
      restoreState(p); showToast('âœ“ Kalkulace naÄtena');
    }catch(err){alert('Chyba: '+err.message);}
    ev.target.value='';
  };
  r.readAsText(file);
}

function restoreState(p) {
  document.getElementById('rows-body').innerHTML='';
  S.sections=[]; S.secRows={}; S.rowData={};
  S._sid=p._sid||0; S._rid=p._rid||0;
  if(p.eurRates) Object.entries(p.eurRates).forEach(([v,rate])=>{
    S.eurRates[v]=rate;
    const el=document.getElementById(`eur-${ev2key(v)}`); if(el) el.value=rate;
  });
  const pn=document.getElementById('proj-name'); if(pn) pn.value=p.projectName||'';
  const dr=document.getElementById('dph-rate'); if(dr) dr.value=p.dph||21; S.dph=p.dph||21;

  (p.sections||[]).forEach(sec=>{
    S.sections.push({id:sec.id,name:sec.name});
    S.secRows[sec.id]=[];
    renderSecHeader(sec.id);
    (sec.rows||[]).forEach(rid=>{
      const rd=(p.rowData||{})[rid]; if(!rd) return;
      S.rowData[rid]={...rd};
      S.secRows[sec.id].push(rid);
      const nOpts=ITEM_TYPES.map(t=>`<option value="${esc(t)}"${t===rd.nazev?' selected':''}>${esc(t)}</option>`).join('');
      const tbody=document.getElementById('rows-body');
      const tr=document.createElement('tr');
      tr.id=`row-${rid}`; tr.dataset.rid=rid; tr.dataset.sid=sec.id;
      tr.className=rd.type==='manual'?'data-row manual-row':'data-row';
      if(rd.type==='catalog'){
        const vOpts=Object.keys(PRICELIST).sort().map(v=>`<option value="${esc(v)}"${v===rd.vendor?' selected':''}>${esc(v)}</option>`).join('');
        const sOpts=rd.vendor?Object.keys(PRICELIST[rd.vendor]||{}).sort().map(s=>`<option value="${esc(s)}"${s===rd.series?' selected':''}>${esc(s)}</option>`).join(''):'';
        const isEur=rd.priceCurrency==='EUR';
        tr.innerHTML=`
          <td class="col-n"><div class="row-num" id="rn-${rid}">â€”</div></td>
          <td class="col-naz"><select id="naz-${rid}" onchange="S.rowData[${rid}].nazev=this.value">${nOpts}</select></td>
          <td><div class="mode-toggle">
            <button class="mode-btn active" onclick="setMode(${rid},'vendor')">VÃ½robce</button>
            <button class="mode-btn" onclick="setMode(${rid},'code')">KÃ³d</button></div></td>
          <td class="col-vr" id="td-vr-${rid}"><select id="sel-v-${rid}" onchange="onVendor(${rid})">
            <option value="">â€” vÃ½robce â€”</option>${vOpts}</select></td>
          <td class="col-sr" id="td-sr-${rid}"><select id="sel-s-${rid}" onchange="onSeries(${rid})" ${rd.vendor?'':'disabled'}>
            <option value="">â€” sÃ©rie â€”</option>${sOpts}</select></td>
          <td class="col-pr"><div class="search-wrap">
            <input type="text" class="search-input" id="srch-${rid}" value="${esc(rd.product||'')}"
              oninput="onSearch(${rid})" onfocus="onSearch(${rid})" onblur="hideDrop(${rid})"
              ${rd.series?'':'disabled'} data-v="${esc(rd.vendor||'')}" data-s="${esc(rd.series||'')}"
              placeholder="â€” vÃ½robek â€”" autocomplete="off">
            <div class="search-drop" id="drop-${rid}"></div></div></td>
          <td class="col-bar"><input type="text" id="color-${rid}" value="${esc(rd.color||'')}" placeholder="â€”" onchange="S.rowData[${rid}].color=this.value"></td>
          <td class="col-kod"><input class="auto-fill" type="text" id="code-${rid}" value="${esc(rd.code||'')}" readonly></td>
          <td class="col-eur"><input class="auto-fill" type="text" id="peur-${rid}" value="${isEur?(fmt(rd.priceEur)+' â‚¬'):'â€”'}" readonly></td>
          <td class="col-czk"><input class="auto-fill" type="text" id="pczk-${rid}" value="${rd.priceCzk?fmt(rd.priceCzk)+' KÄ':'â€”'}" readonly></td>
          <td class="col-ks"><input type="number" id="qty-${rid}" value="${rd.qty||1}" min="1" onchange="S.rowData[${rid}].qty=+this.value;recalcRow(${rid})"></td>
          <td class="col-cel"><span class="line-total" id="tot-${rid}">â€”</span></td>
          <td class="col-kom"><textarea id="note-${rid}" onchange="S.rowData[${rid}].note=this.value">${esc(rd.note||'')}</textarea></td>
          <td class="col-src src-cell" id="src-${rid}">${esc(rd.source||'â€”')}</td>
          <td class="col-act"><div style="display:flex;gap:3px">
            <button class="btn-photo" title="Foto">ğŸ“·</button>
            <button class="btn-del" onclick="delRow(${rid})">âœ•</button></div></td>`;
      } else {
        tr.innerHTML=`
          <td class="col-n"><div class="row-num m" id="rn-${rid}">â€”</div></td>
          <td class="col-naz"><select id="naz-${rid}" onchange="S.rowData[${rid}].nazev=this.value">${nOpts}</select></td>
          <td><span class="manual-tag">RuÄnÃ­</span></td>
          <td class="col-vr"><input type="text" id="sel-v-${rid}" value="${esc(rd.vendor||'')}" placeholder="VÃ½robceâ€¦" style="font-style:italic" onchange="S.rowData[${rid}].vendor=this.value"></td>
          <td class="col-sr"><input type="text" id="sel-s-${rid}" value="${esc(rd.series||'')}" placeholder="Kategorieâ€¦" style="font-style:italic" onchange="S.rowData[${rid}].series=this.value"></td>
          <td class="col-pr"><input type="text" id="srch-${rid}" value="${esc(rd.product||'')}" placeholder="NÃ¡zev vÃ½robkuâ€¦" style="font-style:italic" onchange="S.rowData[${rid}].product=this.value"></td>
          <td class="col-bar"><input type="text" id="color-${rid}" value="${esc(rd.color||'')}" placeholder="â€”" onchange="S.rowData[${rid}].color=this.value"></td>
          <td class="col-kod"><input type="text" id="code-${rid}" value="${esc(rd.code||'')}" placeholder="KÃ³d" onchange="S.rowData[${rid}].code=this.value"></td>
          <td class="col-eur"><input type="number" id="peur-m-${rid}" value="${rd.priceEur||''}" placeholder="0 â‚¬" min="0" step="0.01" onchange="onManualEur(${rid})" style="font-size:12px"></td>
          <td class="col-czk"><input type="number" id="pczk-m-${rid}" value="${rd.priceCzk||''}" placeholder="0 KÄ" min="0" step="1" onchange="onManualCzk(${rid})" style="font-size:12px"></td>
          <td class="col-ks"><input type="number" id="qty-${rid}" value="${rd.qty||1}" min="1" onchange="S.rowData[${rid}].qty=+this.value;recalcRow(${rid})"></td>
          <td class="col-cel"><span class="line-total" id="tot-${rid}">â€”</span></td>
          <td class="col-kom"><textarea id="note-${rid}" onchange="S.rowData[${rid}].note=this.value">${esc(rd.note||'')}</textarea></td>
          <td class="col-src src-manual" id="src-${rid}">RuÄnÃ­</td>
          <td class="col-act"><div style="display:flex;gap:3px">
            <button class="btn-photo" title="Foto">ğŸ“·</button>
            <button class="btn-del" onclick="delRow(${rid})">âœ•</button></div></td>`;
      }
      tbody.appendChild(tr);
    });
  });
  updateRowNums(); recalcAll(); updateSummary();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT XLSX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportXLSX() {
  const proj=document.getElementById('proj-name')?.value||'CenovÃ¡ nabÃ­dka';
  const dph=parseFloat(document.getElementById('dph-rate')?.value)||21;
  const date=new Date().toLocaleDateString('cs-CZ');
  let html=`<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
<head><meta charset="UTF-8"><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets>
<x:ExcelWorksheet><x:Name>CN Kalkulace</x:Name></x:ExcelWorksheet>
</x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]-->
<style>
body{font-family:Calibri,Arial,sans-serif;font-size:11pt;}
.logo-row td{background:#1a1a14;color:#c9a84c;font-size:18pt;font-weight:bold;font-family:Georgia,serif;padding:14px 16px;border:none;}
.meta td{background:#f5f4f0;color:#777;font-size:9.5pt;border:none;padding:2px 16px;}
.hdr th{background:#1a1a14;color:#c9a84c;font-weight:bold;font-size:9pt;text-transform:uppercase;padding:8px 10px;border:1px solid #2a2a1e;}
.sec td{background:#f0ede6;color:#1a1a14;font-weight:bold;font-size:12pt;padding:7px 10px;border:1px solid #ddd;}
td{padding:5px 8px;border:1px solid #e0ddd5;vertical-align:middle;font-size:11pt;}
.num{text-align:right;} .mono{font-family:'Courier New',monospace;font-size:9.5pt;color:#555;}
.gold{color:#c9a84c;font-weight:bold;} .man{background:#fdfcf5;}
.ttl td{background:#1a1a14;color:white;font-weight:bold;text-align:right;padding:8px 10px;border:1px solid #2a2a1e;}
.ttl-gold td{background:#c9a84c;color:#1a1a14;font-weight:bold;text-align:right;font-size:14pt;padding:9px 10px;border:1px solid #b8973e;}
.sec-sub td{background:#faf9f5;text-align:right;color:#888;font-size:9.5pt;padding:5px 10px;border:1px solid #eae7df;}
</style></head><body>
<table style="width:100%;border-collapse:collapse;margin-bottom:18px;">
<tr class="logo-row"><td colspan="14">CN &nbsp;Â·&nbsp; CenovÃ¡ nabÃ­dka materiÃ¡lu</td></tr>
<tr class="meta"><td colspan="14">Projekt: <strong style="color:#333">${esc(proj)}</strong></td></tr>
<tr class="meta"><td colspan="14">Datum: ${date} &nbsp;|&nbsp; DPH: ${dph} %</td></tr>
<tr><td colspan="14" style="border:none;height:8px"></td></tr>
<tr class="hdr"><th>#</th><th>NÃ¡zev pol.</th><th>VÃ½robce</th><th>SÃ©rie</th><th>VÃ½robek</th>
<th>Barva</th><th>KÃ³d</th><th>Cena â‚¬</th><th>Cena KÄ/ks</th><th>Ks</th>
<th>Celkem KÄ</th><th>KomentÃ¡Å™</th><th>Zdroj</th></tr>`;

  let grand=0, n=0;
  S.sections.forEach(sec=>{
    let secTot=0;
    html+=`<tr class="sec"><td colspan="13">${esc(sec.name)}</td></tr>`;
    (S.secRows[sec.id]||[]).forEach(rid=>{
      const rd=S.rowData[rid]; if(!rd) return; n++;
      const qty=parseInt(document.getElementById(`qty-${rid}`)?.value)||1;
      const czk=rd.priceCzk||0; const tot=czk*qty; secTot+=tot;
      const nazev=document.getElementById(`naz-${rid}`)?.value||'';
      const vendor=rd.type==='catalog'?(document.getElementById(`sel-v-${rid}`)?.value||''):(document.getElementById(`sel-v-${rid}`)?.value||'');
      const series=rd.type==='catalog'?(document.getElementById(`sel-s-${rid}`)?.value||''):(document.getElementById(`sel-s-${rid}`)?.value||'');
      const product=document.getElementById(`srch-${rid}`)?.value||'';
      const color=document.getElementById(`color-${rid}`)?.value||'';
      const code=document.getElementById(`code-${rid}`)?.value||'';
      const note=document.getElementById(`note-${rid}`)?.value||'';
      const src=document.getElementById(`src-${rid}`)?.textContent||'';
      const isMan=rd.type==='manual';
      html+=`<tr${isMan?' class="man"':''}>
        <td class="num">${n}</td><td>${esc(nazev)}</td><td>${esc(vendor)}</td>
        <td>${esc(series)}</td><td>${esc(product)}</td><td>${esc(color)}</td>
        <td class="mono">${esc(code)}</td>
        <td class="num">${rd.priceEur?fmt(rd.priceEur)+' â‚¬':''}</td>
        <td class="num">${czk?fmt(czk)+' KÄ':''}</td>
        <td class="num">${qty}</td>
        <td class="num gold">${czk?fmt(tot)+' KÄ':'â€”'}</td>
        <td>${esc(note)}</td>
        <td class="mono" style="font-size:9pt;color:#aaa">${esc(src)}</td></tr>`;
    });
    grand+=secTot;
    html+=`<tr class="sec-sub"><td colspan="10">Sekce: ${esc(sec.name)}</td>
      <td class="num" style="color:#c9a84c;font-weight:bold">${fmt(secTot)} KÄ</td>
      <td colspan="2"></td></tr>
    <tr><td colspan="13" style="border:none;height:6px"></td></tr>`;
  });

  const dphAmt=grand*dph/100;
  html+=`<tr class="ttl"><td colspan="10">MezisouÄet bez DPH</td><td>${fmt(grand)} KÄ</td><td colspan="2"></td></tr>
  <tr class="ttl"><td colspan="10">DPH ${dph} %</td><td>${fmt(dphAmt)} KÄ</td><td colspan="2"></td></tr>
  <tr class="ttl-gold"><td colspan="10">CELKEM S DPH</td><td>${fmt(grand+dphAmt)} KÄ</td><td colspan="2"></td></tr>
  </table></body></html>`;

  const blob=new Blob(['\uFEFF'+html],{type:'application/vnd.ms-excel;charset=UTF-8'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`CN-${(proj).replace(/[^a-zA-Z0-9]/g,'-')}-${new Date().toISOString().slice(0,10)}.xls`;
  a.click();
  showToast('âœ“ ExportovÃ¡no');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmt(n){ return (parseFloat(n)||0).toLocaleString('cs-CZ',{minimumFractionDigits:0,maximumFractionDigits:0}); }
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function setVal(id,v){ const e=document.getElementById(id); if(e)e.value=v; }
function setText(id,v){ const e=document.getElementById(id); if(e)e.textContent=v; }
function showToast(msg){ const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2600); }
</script>
</body>
</html>
